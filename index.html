<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Oracle v17.9 - Harmony Game Edition</title>
    <meta name="theme-color" content="#050508" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Cormorant+Garamond:ital,wght@0,500;1,500&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #D4AF37; --void: #050508; --ethereal: rgba(212, 175, 55, 0.1); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            background-color: var(--void);
            color: #f0f0f0;
            font-family: 'Montserrat', sans-serif;
            height: 100dvh; width: 100vw; overflow: hidden; margin: 0; position: fixed;
            -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
        }
        .font-header { font-family: 'Cinzel', serif; }
        .font-mystic { font-family: 'Cormorant Garamond', serif; }
        
        #universe {
            position: fixed; inset:0; z-index: 0;
            background: radial-gradient(circle at 50% 50%, #1a0b2e 0%, #050508 100%);
            pointer-events: none;
        }
        #universe::before {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 1px, transparent 2px);
            background-size: 400px 400px, 250px 250px;
            animation: cosmicDrift 180s linear infinite;
            opacity: 0.3;
        }
        @keyframes cosmicDrift { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.1); }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; opacity: 0.4; }
            50% { opacity: 1; }
            100% { background-position: 200% 0; opacity: 0.4; }
        }
        .vo-shimmer {
            background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.2), transparent);
            background-size: 200% 100%;
            animation: shimmer 2.5s infinite linear;
        }

        .fade-card-shimmer {
            background: linear-gradient(110deg, #111 8%, #222 18%, #111 33%);
            background-size: 200% 100%;
            animation: shine 2s linear infinite;
        }
        @keyframes shine { to { background-position-x: -200%; } }

        ::-webkit-scrollbar { display: none; }

        .reply-hint {
            position: absolute; right: -50px; top: 50%; transform: translateY(-50%);
            opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .swiping-reply .reply-hint { opacity: 1; right: 15px; }

        #loader {
            position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #000; z-index: 2000; transition: opacity 0.8s; gap: 24px;
        }
        
        @keyframes bounce-subtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-subtle { animation: bounce-subtle 2s infinite ease-in-out; }

        .mic-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
        }
        .mic-bar {
            width: 2px;
            background: #D4AF37;
            border-radius: 1px;
            animation: wave 1s infinite ease-in-out;
        }
        @keyframes wave {
            0%, 100% { height: 4px; }
            50% { height: 18px; }
        }

        /* View Once Pulsate */
        @keyframes pulsate-shimmer {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .vo-pulse { animation: pulsate-shimmer 2s infinite; }
    </style>

    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom": "https://esm.sh/react-dom@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.48.1",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="loader">
        <div class="font-header text-gold text-lg tracking-[12px] animate-pulse">ORACLE AWAKENING</div>
        <div class="w-64 h-[2px] bg-white/5 relative overflow-hidden">
            <div class="absolute inset-0 bg-gold w-1/3 animate-[loading_2s_infinite_ease-in-out]"></div>
        </div>
    </div>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';
        import { createClient } from '@supabase/supabase-js';
        import { drawCardSpecific, initDeck } from './utils/deck.ts';

        const supabase = createClient(
            'https://rruxlxoeelxjjjmhafkc.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydXhseG9lZWx4ampqbWhhZmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDU5OTMsImV4cCI6MjA4NTMyMTk5M30.oR2hl_BDD1P6Dmtos2So-aJ_eoFl1-Kwybt6mQnvq0Q'
        );

        const safeStorage = {
            get: (k) => localStorage.getItem(k),
            set: (k, v) => localStorage.setItem(k, v)
        };

        const cleanTags = (t) => t.replace(/\[VO\]/g, "").replace(/\[VN\]/g, "").replace(/\[REPLY:.*?\]/g, "").replace(/\[SHARED FATE\]/g, "").replace(/\[IMG\].*?(\|)?/g, "üì∑ Photo ").trim();

        const AudioPlayer = ({ url }) => {
            const [isPlaying, setIsPlaying] = useState(false);
            const [progress, setProgress] = useState(0);
            const [duration, setDuration] = useState(0);
            const audioRef = useRef(null);

            const togglePlay = () => {
                if (isPlaying) audioRef.current.pause();
                else audioRef.current.play();
                setIsPlaying(!isPlaying);
            };

            const handleTimeUpdate = () => {
                const p = (audioRef.current.currentTime / audioRef.current.duration) * 100;
                setProgress(p);
            };

            const handleLoadedMetadata = () => setDuration(audioRef.current.duration);

            const formatTime = (time) => {
                if (!time) return "0:00";
                const mins = Math.floor(time / 60);
                const secs = Math.floor(time % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            return (
                <div className="flex items-center gap-3 py-2.5 px-3.5 bg-black/60 rounded-2xl min-w-[220px] shadow-xl border border-white/5 backdrop-blur-sm">
                    <button onClick={togglePlay} className="w-10 h-10 rounded-full bg-gold/10 flex items-center justify-center text-gold shadow-inner active:scale-90 transition-transform">
                        {isPlaying ? (
                            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                        ) : (
                            <svg className="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        )}
                    </button>
                    <div className="flex-1 space-y-1.5">
                        <div className="h-1 bg-white/5 rounded-full overflow-hidden relative">
                            <div className="h-full bg-gold transition-all duration-100" style={{ width: `${progress}%` }}></div>
                        </div>
                        <div className="flex justify-between text-[8px] opacity-30 font-mono tracking-tighter uppercase">
                            <span>{formatTime(audioRef.current?.currentTime)}</span>
                            <span>{formatTime(duration)}</span>
                        </div>
                    </div>
                    <audio 
                        ref={audioRef} 
                        src={url} 
                        onTimeUpdate={handleTimeUpdate} 
                        onLoadedMetadata={handleLoadedMetadata}
                        onEnded={() => setIsPlaying(false)}
                        className="hidden" 
                    />
                </div>
            );
        };

        const OracleCard = ({ raw, onShare }) => {
            try {
                const d = JSON.parse(raw);
                const parts = d.content.split(":");
                const type = (parts[0] || "FATE").toUpperCase();
                const content = parts.slice(1).join(":").trim();
                
                const isLight = type.includes("LIGHT");
                const isDeep = type.includes("DEEP");
                const isChaos = type.includes("CHAOS");

                let borderStyle = "border-gold/30 shadow-gold/10";
                let textStyle = "text-gold";
                if (isLight) { borderStyle = "border-blue-500/50 shadow-blue-500/20 bg-blue-500/5"; textStyle = "text-blue-400"; }
                if (isDeep) { borderStyle = "border-purple-500/50 shadow-purple-500/20 bg-purple-500/5"; textStyle = "text-purple-400"; }
                if (isChaos) { borderStyle = "border-red-500/60 shadow-red-500/40 bg-red-500/5"; textStyle = "text-red-500"; }

                return (
                    <div className={`p-6 rounded-3xl border-2 ${borderStyle} w-full max-w-sm mx-auto shadow-2xl space-y-5 transition-all animate-bounce-subtle`}>
                        <div className="flex justify-between items-center">
                            <span className={`text-[8px] font-header tracking-[8px] uppercase ${textStyle} drop-shadow-[0_0_5px_currentColor]`}>{type}</span>
                            <button onClick={() => onShare(`${type}: ${content}`)} className="p-2 glass rounded-lg hover:bg-white/10 active:scale-90 transition-all">
                                <svg className="w-3.5 h-3.5 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                            </button>
                        </div>
                        <p className="font-mystic text-2xl text-center text-white italic leading-relaxed px-2">"{content}"</p>
                        <div className="pt-3 border-t border-white/5 flex flex-col items-center opacity-40">
                            <span className="text-[7px] text-white font-header tracking-widest uppercase italic">The Oracle has spoken for {d.invoker}</span>
                        </div>
                    </div>
                );
            } catch (e) {
                return <div className="text-red-500 p-4 border border-red-500/20 rounded-xl italic text-xs">Fate Aesthetic Distorted.</div>;
            }
        };

        const Bubble = ({ msg, isMe, onReply, onViewOnce, onShare, onEdit }) => {
            const [swipe, setSwipe] = useState(0);
            const startX = useRef(0);
            const isOracle = msg.nama === "ORACLE";
            const isVO = msg.teks.startsWith("[VO]");
            const isVN = msg.teks.startsWith("[VN]");
            const isIMG = msg.teks.includes("[IMG]");
            const isShared = msg.teks.startsWith("[SHARED FATE]");
            const replyMatch = msg.teks.match(/\[REPLY:(.*?)\]/);
            const replyName = replyMatch ? replyMatch[1] : null;

            let content = msg.teks;
            let imgUrl = null;
            if (isIMG) {
                const parts = content.split("[IMG]");
                imgUrl = parts[1]?.split("|")[0];
                content = parts[0] + (parts[1]?.split("|")[1] || "");
            }

            const handleTouchStart = (e) => { startX.current = e.touches[0].clientX; };
            const handleTouchMove = (e) => {
                const delta = e.touches[0].clientX - startX.current;
                if (delta > 30) setSwipe(Math.min(delta - 30, 80));
            };
            const handleTouchEnd = () => {
                if (swipe > 60) onReply(msg);
                setSwipe(0);
            };

            return (
                <div 
                    onTouchStart={handleTouchStart}
                    onTouchMove={handleTouchMove}
                    onTouchEnd={handleTouchEnd}
                    className={`flex flex-col mb-6 relative transition-transform duration-200 ${isMe ? 'items-end' : 'items-start'} ${swipe > 25 ? 'swiping-reply' : ''}`}
                    style={{ transform: `translateX(${swipe}px)` }}
                >
                    <div className="reply-hint text-gold font-header text-[8px] tracking-[6px] uppercase opacity-0 transition-opacity">MANIFEST ECHO</div>
                    {!isOracle && <span className="text-[7px] font-header text-white/20 tracking-[4px] mb-2 px-3 uppercase">{msg.nama}</span>}
                    
                    <div 
                        onDoubleClick={() => isMe && onEdit(msg)}
                        className={`p-4 max-w-[88%] rounded-3xl transition-all duration-300 relative shadow-2xl ${
                        isOracle ? 'w-full bg-transparent p-0 border-none' : 
                        isVO ? 'bg-red-950/20 border border-red-500/30 text-red-400 vo-shimmer cursor-pointer' :
                        isMe ? 'bg-zinc-900/95 border border-gold/20 text-gold rounded-br-none' : 'bg-zinc-800/80 border border-white/5 text-white/90 rounded-bl-none'
                    }`} onClick={() => isVO && onViewOnce(msg)}>
                        
                        {replyName && (
                            <div className="mb-3 pb-2 border-b border-white/5 text-[9px] opacity-40 italic flex items-center gap-2">
                                <span className="text-gold">‚û•</span> Echoing {replyName}
                            </div>
                        )}

                        {isOracle ? (
                            <OracleCard raw={msg.teks} onShare={onShare} />
                        ) : isVO ? (
                            <div className="flex items-center gap-4 py-1.5">
                                <div className="w-10 h-10 rounded-full border border-red-500/30 flex items-center justify-center animate-pulse">
                                    <span className="text-xl">üëÅÔ∏è</span>
                                </div>
                                <div className="flex flex-col">
                                    <span className="text-[10px] font-header tracking-[5px] uppercase text-red-500/80">Obscured Truth</span>
                                    <span className="text-[7px] opacity-50 uppercase tracking-[2px]">Hold to reveal</span>
                                </div>
                            </div>
                        ) : isVN ? (
                            <AudioPlayer url={msg.teks.replace("[VN]", "")} />
                        ) : (
                            <div className="space-y-3.5">
                                {isIMG && (
                                    <div className="relative rounded-2xl overflow-hidden border border-white/10 bg-black/50 shadow-inner">
                                        <img src={imgUrl} className="max-h-72 w-full object-contain" alt="Cosmic Transmutation" loading="lazy" />
                                    </div>
                                )}
                                <p className="font-mystic text-[18px] leading-relaxed break-words whitespace-pre-wrap">
                                    {isShared ? content.replace("[SHARED FATE]", "‚ú®").trim() : cleanTags(content)}
                                </p>
                            </div>
                        )}
                    </div>
                    <span className="text-[6px] opacity-10 mt-2 px-3 font-mono uppercase tracking-[4px]">{new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                </div>
            );
        };

        function App() {
            const [layer, setLayer] = useState(() => safeStorage.get('oracle_adult') ? 'SECURITY' : 'AGE');
            const [isAdult, setIsAdult] = useState(() => safeStorage.get('oracle_adult') === 'true');
            const [username, setUsername] = useState(() => safeStorage.get('oracle_user') || '');
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [replyingTo, setReplyingTo] = useState(null);
            const [editingMsg, setEditingMsg] = useState(null);
            const [isVO, setIsVO] = useState(false);
            const [fateMode, setFateMode] = useState(null); // 'intensity' | 'type'
            const [selectedIntensity, setSelectedIntensity] = useState(null);
            const [loading, setLoading] = useState(null);
            const [conn, setConn] = useState('OFFLINE');
            const [isRecording, setIsRecording] = useState(false);
            const [recordedBlob, setRecordedBlob] = useState(null);
            const [recordingTime, setRecordingTime] = useState(0);
            
            const deckRef = useRef(initDeck());
            const fileInputRef = useRef(null);
            const feedRef = useRef(null);
            const recorderRef = useRef(null);
            const timerRef = useRef(null);

            // Supabase Sync & Auto-Reconnection
            useEffect(() => {
                if (layer !== 'MAIN') return;
                let channel;
                let retryTimeout;

                const connect = async () => {
                    setConn('SYNCING');
                    const { data } = await supabase.from('Pesan').select('*').order('id', { ascending: true });
                    if (data) setMessages(data);

                    channel = supabase.channel('oracle_live_stream')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'Pesan' }, (p) => {
                            if (p.eventType === 'INSERT') {
                                setMessages(v => [...v, p.new]);
                                if (!document.hasFocus() && p.new.nama !== username && 'Notification' in window && Notification.permission === 'granted') {
                                    new Notification(`Messenger: ${p.new.nama}`, {
                                        body: cleanTags(p.new.teks),
                                        icon: 'https://cdn-icons-png.flaticon.com/512/3062/3062634.png'
                                    });
                                }
                            }
                            if (p.eventType === 'UPDATE') setMessages(v => v.map(m => m.id === p.new.id ? p.new : m));
                            if (p.eventType === 'DELETE') setMessages(v => v.filter(m => m.id !== p.old.id));
                            setTimeout(() => feedRef.current?.scrollTo({ top: feedRef.current.scrollHeight, behavior: 'smooth' }), 100);
                        })
                        .subscribe((status) => {
                            setConn(status === 'SUBSCRIBED' ? 'ONLINE' : 'ERROR');
                            if (status !== 'SUBSCRIBED') {
                                clearTimeout(retryTimeout);
                                retryTimeout = setTimeout(connect, 5000);
                            }
                        });
                };

                connect();
                return () => {
                    supabase.removeChannel(channel);
                    clearTimeout(retryTimeout);
                };
            }, [layer, username]);

            useEffect(() => {
                const l = document.getElementById('loader');
                if (l) setTimeout(() => { l.style.opacity = '0'; setTimeout(() => l.remove(), 800); }, 500);
            }, []);

            const handleImage = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoading("Transmuting Image...");
                try {
                    const ext = file.name.split('.').pop();
                    const path = `uploads/${Date.now()}.${ext}`;
                    const { error } = await supabase.storage.from('bukti').upload(path, file);
                    if (error) throw error;
                    const { data: { publicUrl } } = supabase.storage.from('bukti').getPublicUrl(path);
                    await handleSend(`[IMG]${publicUrl}|`);
                } catch (err) { alert("Alchemy Error: " + err.message); }
                setLoading(null);
            };

            const handleSend = async (customTeks = null) => {
                const txt = (customTeks || inputText).trim();
                if (!txt && !recordedBlob) return;
                
                let final = txt;
                if (isVO && !txt.startsWith("[VO]")) final = `[VO]${final}`;
                if (replyingTo) final = `[REPLY:${replyingTo.nama}] ${final}`;

                if (recordedBlob) {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        await supabase.from('Pesan').insert([{ nama: username, teks: `[VN]${reader.result}` }]);
                    };
                    reader.readAsDataURL(recordedBlob);
                    setRecordedBlob(null);
                } else if (editingMsg) {
                    await supabase.from('Pesan').update({ teks: final }).eq('id', editingMsg.id);
                    setEditingMsg(null);
                } else {
                    await supabase.from('Pesan').insert([{ nama: username, teks: final }]);
                }
                setInputText('');
                setReplyingTo(null);
                setIsVO(false);
            };

            const startVN = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const recorder = new MediaRecorder(stream);
                    const chunks = [];
                    recorder.ondataavailable = e => chunks.push(e.data);
                    recorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/ogg' });
                        setRecordedBlob(blob);
                        setIsRecording(false);
                        clearInterval(timerRef.current);
                    };
                    recorder.start();
                    recorderRef.current = recorder;
                    setIsRecording(true);
                    setRecordingTime(0);
                    timerRef.current = setInterval(() => setRecordingTime(t => t + 1), 1000);
                } catch { alert("Microphone Denied."); }
            };

            const stopVN = () => { recorderRef.current?.stop(); };

            const invokeFate = async (type) => {
                setLoading(`Peering into Fate...`);
                const { content, newDeck } = drawCardSpecific(deckRef.current, selectedIntensity, type);
                deckRef.current = newDeck;
                await supabase.from('Pesan').insert([{ nama: "ORACLE", teks: JSON.stringify({ content, invoker: username }) }]);
                setFateMode(null);
                setSelectedIntensity(null);
                setLoading(null);
            };

            if (layer === 'AGE') return (
                <div className="h-screen bg-black flex flex-col items-center justify-center p-12 space-y-20">
                    <div className="space-y-4 text-center">
                        <h1 className="font-header text-gold text-4xl tracking-[12px]">VERITAS</h1>
                        <p className="text-[10px] tracking-[8px] text-white/30 uppercase">Consent to Manifest</p>
                    </div>
                    <div className="flex flex-col gap-6 w-full max-w-sm">
                        <button onClick={() => { setIsAdult(true); safeStorage.set('oracle_adult', 'true'); setLayer('SECURITY'); }} className="p-7 border border-gold/40 text-gold font-header glass tracking-[10px] shadow-[0_0_30px_rgba(212,175,55,0.15)] active:scale-95 transition-all text-sm">MANIFEST 18+</button>
                        <button onClick={() => { setIsAdult(false); safeStorage.set('oracle_adult', 'false'); setLayer('SECURITY'); }} className="p-7 border border-white/10 text-white/30 font-header tracking-[10px] active:scale-95 transition-all text-sm">UNDER 18</button>
                    </div>
                </div>
            );

            if (layer === 'SECURITY') return (
                <div className="h-screen bg-black flex flex-col items-center justify-center p-8 space-y-16">
                    <h1 className="font-header text-gold tracking-[20px] text-2xl drop-shadow-[0_0_10px_gold]">ORACLE</h1>
                    <input type="password" placeholder="CODE" autoFocus onChange={(e) => { if(e.target.value === '010304') setLayer(username ? 'MAIN' : 'NAME'); }} className="bg-transparent border-b border-gold text-center py-6 outline-none text-gold tracking-[25px] w-64 text-5xl font-mono transition-all focus:w-72" />
                </div>
            );

            if (layer === 'NAME') return (
                <div className="h-screen bg-black flex flex-col items-center justify-center p-12 space-y-20">
                    <h1 className="font-header text-gold tracking-[10px] text-2xl uppercase">Who Art Thou?</h1>
                    <input type="text" maxLength={12} placeholder="..." value={username} onChange={(e) => setUsername(e.target.value.toUpperCase())} className="bg-transparent border-b border-white/30 text-center py-6 outline-none w-full max-w-[300px] font-mystic text-5xl text-white uppercase" />
                    <button onClick={() => { if(username.trim()){ safeStorage.set('oracle_user', username); setLayer('MAIN'); } }} className="px-24 py-6 border border-gold text-gold font-header tracking-widest text-lg glass shadow-2xl active:scale-95 transition-all">ENTER</button>
                </div>
            );

            return (
                <div className="h-screen bg-void flex flex-col relative overflow-hidden">
                    <div id="universe"></div>
                    
                    {loading && (
                        <div className="fixed inset-0 z-[1000] bg-black/95 backdrop-blur-2xl flex flex-col items-center justify-center gap-8">
                            <div className="w-16 h-16 border-2 border-gold border-t-transparent animate-spin rounded-full shadow-[0_0_30px_gold]"></div>
                            <span className="font-header text-gold text-[12px] tracking-[12px] uppercase animate-pulse drop-shadow-[0_0_5px_gold]">{loading}</span>
                        </div>
                    )}

                    <header className="p-6 border-b border-white/5 bg-black/80 backdrop-blur-3xl z-[100] flex justify-between items-center relative shadow-2xl">
                        <div className="flex flex-col">
                            <span className="font-header text-gold text-[12px] tracking-[10px]">ORACLE v17.9.8</span>
                            <div className="flex items-center gap-2.5">
                                <div className={`w-2 h-2 rounded-full ${conn === 'ONLINE' ? 'bg-green-500 shadow-[0_0_12px_green]' : 'bg-red-500 animate-pulse'}`}></div>
                                <span className="text-[8px] opacity-40 uppercase font-mono tracking-tighter">{conn}</span>
                            </div>
                        </div>
                        <button onClick={() => { if(confirm("Purge Room?")) supabase.from('Pesan').delete().neq('id', 0); }} className="p-3 glass border-none rounded-2xl text-red-500/60 text-[9px] uppercase tracking-widest active:scale-90 transition-transform">Purge</button>
                    </header>

                    <main ref={feedRef} className="flex-1 overflow-y-auto p-6 z-[10] space-y-2 scroll-smooth pt-12 pb-32">
                        {messages.map(m => (
                            <Bubble key={m.id} msg={m} isMe={m.nama === username} onReply={setReplyingTo} onEdit={(msg) => { setEditingMsg(msg); setInputText(cleanTags(msg.teks)); }} onShare={handleSend} onViewOnce={() => alert("Hold reveal mechanism pending final encryption v17.9.9")} />
                        ))}
                    </main>

                    {/* FATE MENU OVERLAY */}
                    {fateMode && (
                        <div className="fixed inset-0 z-[500] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6" onClick={() => setFateMode(null)}>
                            <div className="w-full max-w-sm glass border border-gold/30 rounded-[40px] p-8 space-y-8 animate-slide-up" onClick={e => e.stopPropagation()}>
                                <div className="text-center">
                                    <h2 className="font-header text-gold text-[12px] tracking-[10px] uppercase">{fateMode === 'intensity' ? 'Select Intensity' : 'Select Category'}</h2>
                                </div>
                                {fateMode === 'intensity' ? (
                                    <div className="flex flex-col gap-4">
                                        <button onClick={() => { setSelectedIntensity('LIGHT'); setFateMode('type'); }} className="p-6 border border-blue-500/20 text-blue-400 font-header text-xs tracking-widest rounded-3xl bg-blue-500/5 hover:bg-blue-500/10">üïäÔ∏è LIGHT</button>
                                        <button onClick={() => { setSelectedIntensity('DEEP'); setFateMode('type'); }} className="p-6 border border-purple-500/20 text-purple-400 font-header text-xs tracking-widest rounded-3xl bg-purple-500/5 hover:bg-purple-500/10">ü™ê DEEP</button>
                                        <button disabled={!isAdult} onClick={() => { setSelectedIntensity('CHAOS'); setFateMode('type'); }} className={`p-6 border border-red-500/20 text-red-500 font-header text-xs tracking-widest rounded-3xl bg-red-500/5 ${!isAdult ? 'opacity-20' : 'hover:bg-red-500/10'}`}>üî• CHAOS</button>
                                    </div>
                                ) : (
                                    <div className="flex flex-col gap-4">
                                        <button onClick={() => invokeFate('truths')} className="p-6 border border-gold/20 text-gold font-header text-xs tracking-widest rounded-3xl">‚öñÔ∏è TRUTH</button>
                                        <button onClick={() => invokeFate('dares')} className="p-6 border border-gold/20 text-gold font-header text-xs tracking-widest rounded-3xl">‚öîÔ∏è DARE</button>
                                        <button onClick={() => invokeFate('wildcards')} className="p-6 border border-gold/20 text-gold font-header text-xs tracking-widest rounded-3xl">üÉè WILD</button>
                                        <button onClick={() => { setFateMode('intensity'); setSelectedIntensity(null); }} className="text-[10px] opacity-40 uppercase tracking-widest mt-4">Go Back</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="bg-black/95 backdrop-blur-3xl border-t border-white/5 z-[200] relative safe-touch px-6 pb-12">
                        
                        {/* MICROPHONE RECORDING AREA */}
                        {isRecording && (
                            <div className="flex items-center justify-between py-5 border-b border-white/5 animate-slide-up">
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center animate-pulse border border-red-500/30">
                                        <div className="w-3 h-3 bg-red-500 rounded-sm"></div>
                                    </div>
                                    <div className="flex flex-col">
                                        <span className="text-red-500 font-mono text-xl tracking-tighter">{recordingTime}s</span>
                                        <div className="mic-wave">
                                            {[...Array(8)].map((_, i) => <div key={i} className="mic-bar" style={{ animationDelay: `${i * 0.12}s` }}></div>)}
                                        </div>
                                    </div>
                                </div>
                                <button onClick={stopVN} className="p-4 bg-red-500 text-white rounded-3xl font-header text-[10px] tracking-widest uppercase shadow-lg shadow-red-500/20 active:scale-95 transition-all">Release Void</button>
                            </div>
                        )}

                        {recordedBlob && (
                            <div className="flex items-center justify-between py-5 border-b border-white/5 animate-slide-up">
                                <div className="flex items-center gap-3">
                                    <button onClick={() => setRecordedBlob(null)} className="w-12 h-12 rounded-full border border-red-500/30 text-red-500 flex items-center justify-center active:scale-90">‚úï</button>
                                    <span className="text-[9px] font-header tracking-widest opacity-40 uppercase">Manifesting Audio...</span>
                                </div>
                                <button onClick={() => handleSend()} className="px-6 py-4 bg-gold text-black rounded-3xl font-header text-[10px] tracking-widest uppercase shadow-lg shadow-gold/30 active:scale-95 transition-all font-bold">Transmit</button>
                            </div>
                        )}
                        
                        {replyingTo && (
                            <div className="flex justify-between items-center glass p-4 px-6 border-none rounded-none text-[11px] opacity-90 bg-gold/5 mt-2">
                                <div className="flex items-center gap-3">
                                    <span className="text-gold animate-pulse text-lg">‚û•</span>
                                    <span>Whisper back to <b>{replyingTo.nama}</b></span>
                                </div>
                                <button onClick={() => setReplyingTo(null)} className="w-8 h-8 flex items-center justify-center bg-white/10 rounded-full text-white text-sm hover:bg-white/20 transition-all">√ó</button>
                            </div>
                        )}

                        <div className="pt-6 flex gap-5 items-center max-w-5xl mx-auto">
                            <button onClick={() => setFateMode('intensity')} className={`w-14 h-14 shrink-0 rounded-2xl glass border-gold/40 flex items-center justify-center text-3xl transition-all active:scale-90 text-gold shadow-[0_0_20px_rgba(212,175,55,0.1)]`}>‚ú®</button>
                            
                            <div className="flex-1 glass rounded-3xl flex items-center px-6 py-2 border-white/10 bg-white/5 group focus-within:border-gold/40 transition-all shadow-inner">
                                <input 
                                    type="text" 
                                    value={inputText} 
                                    onChange={e => setInputText(e.target.value)} 
                                    onKeyDown={e => { if(e.key === 'Enter') handleSend(); }}
                                    placeholder={editingMsg ? "Whispering update..." : "Whisper to void..."} 
                                    className="flex-1 bg-transparent py-4 outline-none text-white text-[16px] font-mystic min-w-0 placeholder-white/10" 
                                />
                                <button onClick={() => setIsVO(!isVO)} className={`p-3.5 transition-all active:scale-125 ${isVO ? 'text-red-500 opacity-100 drop-shadow-[0_0_12px_red]' : 'opacity-20 text-white'}`}>üëÅÔ∏è</button>
                                <button onClick={() => fileInputRef.current.click()} className="p-3.5 opacity-30 text-white active:scale-125 transition-all">üì∑</button>
                            </div>

                            <div className="flex items-center gap-3">
                                {!isRecording && !recordedBlob && (
                                    <button 
                                        onMouseDown={startVN} 
                                        onTouchStart={startVN} 
                                        className={`w-14 h-14 shrink-0 rounded-full flex items-center justify-center transition-all shadow-xl border bg-gold/10 border-gold/40 text-gold active:scale-95`}
                                    >
                                        <span className="text-2xl">üé§</span>
                                    </button>
                                )}
                                <button onClick={() => handleSend()} className="w-14 h-14 flex items-center justify-center text-gold text-4xl active:scale-125 transition-transform drop-shadow-[0_0_20px_rgba(212,175,55,0.4)]">‚û§</button>
                            </div>
                        </div>
                        <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImage} />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>