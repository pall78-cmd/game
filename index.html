<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORACLE v17.9 - HARMONY</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./config.js"></script>
    <script src="./deck.js"></script>
    <script src="./audioManager.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: '#D4AF37',
                        void: '#050508',
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                        header: ['Cinzel', 'serif'],
                        mystic: ['Cormorant Garamond', 'serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'ready-pulse': 'readyPulse 2s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        readyPulse: {
                            '0%, 100%': { transform: 'scale(1)', boxShadow: '0 0 0px rgba(212, 175, 55, 0)' },
                            '50%': { transform: 'scale(1.1)', boxShadow: '0 0 15px rgba(212, 175, 55, 0.4)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root { 
            --gold: #D4AF37; 
            --void: #050508; 
        }
        
        body {
            background-color: var(--void);
            color: #f0f0f0;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.2);
            border-radius: 10px;
        }

        #loader {
            position: fixed;
            inset: 0;
            background: black;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            gap: 2rem;
        }

        .vo-pulse { animation: pulsate-shimmer 2s infinite; }
        @keyframes pulsate-shimmer {
            0% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.2); }
            50% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
            100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.2); }
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .feed-container {
            mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 95%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 95%, transparent 100%);
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="font-header text-gold text-lg tracking-[12px] animate-pulse">ORACLE AWAKENING</div>
        <div class="w-64 h-[2px] bg-white/5 relative overflow-hidden">
            <div class="absolute inset-0 bg-gold/40 animate-[shimmer_2s_infinite]" style="width: 50%; left: -50%;"></div>
        </div>
        <style>
            @keyframes shimmer {
                0% { left: -50%; }
                100% { left: 100%; }
            }
        </style>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = window.React;

        function parsePreviewText(text) {
            if (!text) return "";
            let actual = text;
            
            // Handle nested replies recursively or just strip the outer one
            while (actual.startsWith('[REPLY:')) {
                const endIdx = actual.indexOf('}]');
                if (endIdx !== -1) {
                    actual = actual.substring(endIdx + 2);
                } else {
                    break;
                }
            }

            if (actual.startsWith('[IMG]')) return "Image üñºÔ∏è";
            if (actual.startsWith('[VN]')) return "Voice Note üéôÔ∏è";
            if (actual.startsWith('[VO]')) return "Secret Glimpse üëÅÔ∏è";
            if (actual.startsWith('GAME ')) {
                const parts = actual.split(':');
                return `üîÆ ${parts[0]}`;
            }
            return actual.substring(0, 40) + (actual.length > 40 ? "..." : "");
        }
        window.parsePreviewText = parsePreviewText;

        // --- CONSTANTS & UTILS ---
        const { SUPA_URL, SUPA_KEY } = window.ORACLE_CONFIG;
        
        const { createClient } = window.supabase;
        const supabaseClient = createClient(SUPA_URL, SUPA_KEY);

        const uploadImage = async (file) => {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random()}.${fileExt}`;
            const filePath = `uploads/${fileName}`;
            const { data, error } = await supabaseClient.storage.from('bukti').upload(filePath, file);
            if (error) throw new Error(error.message);
            const { data: { publicUrl } } = supabaseClient.storage.from('bukti').getPublicUrl(filePath);
            return publicUrl;
        };

        const safeStorage = {
            get: (key) => {
                try { return localStorage.getItem(key); } catch { return null; }
            },
            set: (key, value) => {
                try { localStorage.setItem(key, value); } catch { }
            }
        };

        // --- COMPONENTS ---

        const AudioPlayer = ({ url, isPlaying, onToggle }) => {
            const [progress, setProgress] = useState(0);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [error, setError] = useState(false);
            const audioRef = useRef(null);

            // Parse URL and duration if available
            const { cleanUrl, initialDuration } = useMemo(() => {
                if (!url) return { cleanUrl: "", initialDuration: 0 };
                const parts = url.split('|');
                const clean = parts[0].trim();
                const dur = parts[1] ? parseFloat(parts[1]) : 0;
                
                // Debug log to verify URL
                console.log("Audio Parsing:", { raw: url, clean, dur });
                
                return { 
                    cleanUrl: clean, 
                    initialDuration: dur 
                };
            }, [url]);

            useEffect(() => {
                if (initialDuration > 0) setDuration(initialDuration);
            }, [initialDuration]);

            useEffect(() => {
                if (isPlaying) {
                    if (!cleanUrl) {
                        console.warn("Attempted to play empty URL");
                        onToggle();
                        return;
                    }
                    setError(false);
                    const playPromise = audioRef.current?.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.error("Playback failed:", error.message);
                            onToggle(); // Reset state if play fails
                        });
                    }
                } else {
                    audioRef.current?.pause();
                }
            }, [isPlaying, cleanUrl]);

            const formatTime = (time) => {
                if (isNaN(time) || !isFinite(time)) return "0:00";
                const mins = Math.floor(time / 60);
                const secs = Math.floor(time % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const handleSeek = (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const pct = x / rect.width;
                const newTime = pct * duration;
                audioRef.current.currentTime = newTime;
                setProgress(pct * 100);
            };

            const skip = (seconds) => {
                if (audioRef.current) {
                    audioRef.current.currentTime = Math.max(0, Math.min(duration, audioRef.current.currentTime + seconds));
                }
            };

            return (
                <div className="flex flex-col gap-2 min-w-[220px] py-3 px-4 bg-black/30 rounded-2xl border border-white/5 shadow-inner">
                    <div className="flex items-center gap-4">
                        <button onClick={onToggle} className="w-12 h-12 rounded-full bg-gold/20 border border-gold/40 text-gold flex items-center justify-center active:scale-90 transition-transform shadow-lg flex-shrink-0">
                            {isPlaying ? <span className="text-xs font-bold">||</span> : <span className="ml-1 text-lg">‚ñ∂</span>}
                        </button>
                        
                        <div className="flex-1 flex flex-col gap-1.5">
                            <div 
                                className="h-1.5 bg-white/10 rounded-full overflow-hidden cursor-pointer relative"
                                onClick={handleSeek}
                            >
                                <div className="h-full bg-gold transition-all duration-100" style={{ width: `${progress}%` }}></div>
                            </div>
                            <div className="flex justify-between text-[9px] font-mono text-white/40 uppercase tracking-tighter">
                                <span>{formatTime(currentTime)}</span>
                                <span>{formatTime(duration)}</span>
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-center gap-6 pt-1 border-t border-white/5">
                        <button onClick={() => skip(-5)} className="text-[10px] text-white/30 hover:text-gold transition-colors uppercase tracking-widest font-header">¬´ 5s</button>
                        <button onClick={() => skip(5)} className="text-[10px] text-white/30 hover:text-gold transition-colors uppercase tracking-widest font-header">5s ¬ª</button>
                    </div>
                    
                    {error && (
                        <div className="flex flex-col items-center gap-2 pt-2">
                            <span className="text-[9px] text-red-400 uppercase tracking-widest">Gagal memutar (Custom Player)</span>
                            <audio controls src={cleanUrl} className="w-full h-8 opacity-80" />
                            <a 
                                href={cleanUrl} 
                                target="_blank" 
                                rel="noopener noreferrer" 
                                className="text-[8px] text-white/40 hover:text-gold underline decoration-dotted uppercase tracking-widest"
                            >
                                Buka File Langsung ‚Üó
                            </a>
                        </div>
                    )}

                    <audio 
                        ref={audioRef} 
                        src={cleanUrl} 
                        preload="metadata"
                        playsInline
                        onError={(e) => {
                            const err = e.target.error;
                            console.error("Audio Playback Error:", err);
                            if (err && err.code === 4) {
                                console.warn("Source not supported or file not found:", cleanUrl);
                            }
                            setError(true);
                            onToggle();
                        }}
                        onTimeUpdate={() => {
                            const curr = audioRef.current.currentTime;
                            const dur = audioRef.current.duration;
                            setCurrentTime(curr);
                            // Use metadata duration if available and valid, otherwise fallback to passed duration
                            const validDuration = (isFinite(dur) && dur > 0) ? dur : duration;
                            if (validDuration > 0) {
                                setProgress((curr / validDuration) * 100);
                                if (!isFinite(dur)) setDuration(validDuration); // Update state if audio element fails
                            }
                        }} 
                        onLoadedMetadata={() => {
                            const dur = audioRef.current.duration;
                            if (isFinite(dur) && dur > 0) setDuration(dur);
                        }}
                        onEnded={onToggle} 
                        className="hidden" 
                    />
                </div>
            );
        };

        const FateCardDisplay = ({ raw, onShare }) => {
            try {
                const d = JSON.parse(raw);
                const contentStr = d.content || "";
                let type = "FATE";
                let content = contentStr;

                if (contentStr.startsWith("GAME ")) {
                    const parts = contentStr.split(":");
                    type = parts[0]; // e.g. "GAME LIGHT TRUTH"
                    content = parts.slice(1).join(":").trim();
                } else {
                    const parts = contentStr.split(":");
                    type = parts[0] || "FATE";
                    content = parts.slice(1).join(":").trim() || contentStr;
                }
                
                const isChaos = type.includes("CHAOS");

                return (
                    <div className={`p-4 rounded-xl border border-gold/30 bg-gradient-to-br from-black to-zinc-900 text-center space-y-3 shadow-lg relative overflow-hidden group`}>
                        <div className="text-[8px] font-header tracking-[4px] uppercase opacity-60 text-gold">{type}</div>
                        <div className="font-mystic text-xl italic text-white/90 leading-normal">"{content}"</div>
                        <div className="text-[7px] opacity-30 uppercase tracking-widest font-header pt-1">Invoked by {d.invoker}</div>
                    </div>
                );
            } catch { return <div className="p-3 text-red-500 border border-red-500/20 rounded-lg text-xs italic">Takdir yang Terdistorsi</div>; }
        };

        const MessageContent = ({ type, content, currentAudioId, msgId, onPlayAudio, isMe, isSecret = false }) => {
            if (type === "vn") {
                return <AudioPlayer url={content} isPlaying={currentAudioId === msgId} onToggle={() => onPlayAudio(currentAudioId === msgId ? null : msgId)} />;
            }
            if (type === "img") {
                const parts = content.split("\n");
                const url = parts[0];
                const caption = parts.slice(1).join("\n");
                return (
                    <div className="flex flex-col gap-2">
                        <img src={url} className={`rounded-lg ${isSecret ? 'max-h-96' : 'max-h-64'} w-full object-contain`} />
                        {caption && <p className={`font-sans ${isSecret ? 'text-lg text-center' : 'text-[15px] pr-12'} leading-tight break-words whitespace-pre-wrap`}>{caption}</p>}
                    </div>
                );
            }
            return <p className={`font-sans ${isSecret ? 'text-xl text-center leading-relaxed' : 'text-[15px] pr-12'} leading-tight break-words whitespace-pre-wrap`}>{content}</p>;
        };

        const Bubble = ({ msg, isMe, onReply, onEdit, onViewOnce, onShare, currentAudioId, onPlayAudio, onVisible }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const [swipeX, setSwipeX] = useState(0);
            const touchStartRef = useRef(0);
            const longPressTimerRef = useRef(null);
            const bubbleRef = useRef(null);

            useEffect(() => {
                if (!bubbleRef.current || isMe) return;
                const observer = new IntersectionObserver(([entry]) => {
                    if (entry.isIntersecting) {
                        onVisible(msg.id);
                        observer.disconnect();
                    }
                }, { threshold: 0.8 });
                observer.observe(bubbleRef.current);
                return () => observer.disconnect();
            }, [bubbleRef, msg.id, isMe, onVisible]);

            const parsed = useMemo(() => {
                let teks = msg.teks || "";
                let isVO = false;
                let replyData = null;

                if (teks.startsWith("[VO]")) {
                    isVO = true;
                    teks = teks.substring(4);
                }

                const replyRegex = /^\[REPLY:(.+?)\](.*)$/s;
                const match = teks.match(replyRegex);
                if (match) {
                    try {
                        replyData = JSON.parse(match[1]);
                        teks = match[2].trim();
                    } catch (e) {}
                }

                let type = "text";
                let content = teks;
                if (teks.startsWith("[VN]")) {
                    type = "vn";
                    content = teks.substring(4).trim();
                } else if (teks.startsWith("[IMG]")) {
                    type = "img";
                    content = teks.substring(5).trim();
                }

                return { isVO, replyData, type, content };
            }, [msg.teks]);

            const isOracle = msg.nama === "ORACLE";
            
            const identity = useMemo(() => {
                const parts = msg.nama.split('|');
                return { name: parts[0], avatar: parts[1] || 'üîÆ', color: parts[2] || '#D4AF37' };
            }, [msg.nama]);

            const handleTouchStart = (e) => {
                touchStartRef.current = e.touches[0].clientX;
                if (isMe && !isOracle) {
                    longPressTimerRef.current = setTimeout(() => {
                        if (navigator.vibrate) navigator.vibrate(50);
                        onEdit(msg);
                    }, 600);
                }
            };

            const handleTouchMove = (e) => {
                const diff = e.touches[0].clientX - touchStartRef.current;
                if (Math.abs(diff) > 10 && longPressTimerRef.current) {
                    clearTimeout(longPressTimerRef.current);
                }
                if (diff > 0 && diff < 80) {
                    setSwipeX(diff);
                }
            };

            const handleTouchEnd = () => {
                if (longPressTimerRef.current) clearTimeout(longPressTimerRef.current);
                if (swipeX > 40) {
                    if (navigator.vibrate) navigator.vibrate(20);
                    onReply(msg);
                }
                setSwipeX(0);
            };

            const formatTime = (dateStr) => {
                const d = new Date(dateStr);
                return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            };

            const renderReplyPreview = (data) => {
                const preview = parsePreviewText(data.text);
                const isImg = data.text.trim().startsWith("[IMG]");
                const imgUrl = isImg ? data.text.trim().substring(5).split('\n')[0].trim() : null;

                return (
                    <div className="mb-1 p-2 rounded bg-black/10 border-l-4 border-gold/50 text-[10px] opacity-80 italic flex justify-between items-center gap-2 overflow-hidden">
                        <div className="truncate">
                            <span className="font-bold text-gold not-italic">{data.name}:</span> {preview}
                        </div>
                        {imgUrl && <img src={imgUrl} className="w-8 h-8 rounded object-cover flex-shrink-0" />}
                    </div>
                );
            };

            return (
                <div 
                    ref={bubbleRef}
                    className={`flex flex-col mb-2 animate-fade-in relative transition-transform duration-200 ${isOracle ? 'items-center w-full my-4' : isMe ? 'items-end' : 'items-start'}`}
                    style={{ transform: `translateX(${swipeX}px)` }}
                    onTouchStart={handleTouchStart}
                    onTouchMove={handleTouchMove}
                    onTouchEnd={handleTouchEnd}
                >
                    {swipeX > 20 && (
                        <div className="absolute left-[-30px] top-1/2 -translate-y-1/2 text-gold opacity-50">‚Ü©Ô∏è</div>
                    )}

                    {!isOracle && (
                        <div className={`flex items-center gap-1.5 mb-0.5 px-2 ${isMe ? 'flex-row-reverse' : 'flex-row'}`}>
                            <span className="text-[10px]">{identity.avatar}</span>
                            <span className="text-[9px] font-bold uppercase tracking-wider" style={{ color: identity.color }}>{identity.name}</span>
                        </div>
                    )}
                    
                    <div className={`relative p-3 w-fit max-w-[88%] rounded-2xl border transition-all shadow-md ${
                        isOracle ? 'w-full max-w-sm bg-transparent border-none' : 
                        parsed.isVO ? 'bg-gradient-to-br from-red-950/60 to-red-900/40 border-red-500/30 text-red-400 cursor-pointer' :
                        isMe ? 'bg-gradient-to-br from-[#056162] to-[#075e54] border-none text-white rounded-tr-none' : 
                        'bg-gradient-to-br from-[#262d31] to-[#1f2428] border-none text-white rounded-tl-none'
                    }`} onClick={() => parsed.isVO && onViewOnce(msg)}>
                        {/* WhatsApp-style Tail */}
                        {!isOracle && (
                            <div className={`absolute top-0 w-0 h-0 border-t-[10px] border-t-transparent ${
                                isMe ? 'right-[-8px] border-l-[10px] border-l-[#056162]' : 'left-[-8px] border-r-[10px] border-r-[#262d31]'
                            }`}></div>
                        )}

                        {parsed.replyData && renderReplyPreview(parsed.replyData)}
                        
                        <div className="flex flex-col">
                            {isOracle ? <FateCardDisplay raw={parsed.content} onShare={onShare} /> :
                             parsed.isVO ? (
                                <div className="flex items-center gap-3">
                                    <span className="text-xl">üëÅÔ∏è</span>
                                    <div className="flex flex-col">
                                        <span className="text-[9px] font-header tracking-widest uppercase">Secret Glimpse</span>
                                        <span className="text-[7px] opacity-40 uppercase">Tap to reveal</span>
                                    </div>
                                </div>
                             ) : (
                                <MessageContent 
                                    type={parsed.type} 
                                    content={parsed.content} 
                                    msgId={msg.id} 
                                    currentAudioId={currentAudioId} 
                                    onPlayAudio={onPlayAudio} 
                                    isMe={isMe} 
                                />
                             )
                            }
                            
                            {!isOracle && (
                                <div className="flex items-center justify-end gap-1 mt-1 self-end">
                                    <span className="text-[9px] opacity-50 font-sans">{formatTime(msg.created_at)}</span>
                                    {isMe && <span className={`text-[10px] ${msg.is_read ? 'text-[#34b7f1]' : 'text-white/40'}`}>‚úì‚úì</span>}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---

        const BackgroundMusic = ({ tracks, volume, isMuted, shouldDuck }) => {
            const audioRef = useRef(null);
            const [currentTrackIndex, setCurrentTrackIndex] = useState(0);
            
            useEffect(() => {
                const audio = audioRef.current;
                if (!audio) return;
                
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log("Auto-play prevented:", error);
                        const startAudio = () => {
                            audio.play();
                            document.removeEventListener('click', startAudio);
                            document.removeEventListener('touchstart', startAudio);
                        };
                        document.addEventListener('click', startAudio);
                        document.addEventListener('touchstart', startAudio);
                    });
                }
            }, [currentTrackIndex]);

            useEffect(() => {
                const audio = audioRef.current;
                if (!audio) return;

                const targetVolume = (isMuted || shouldDuck) ? 0 : volume;
                
                const fade = setInterval(() => {
                    const current = audio.volume;
                    
                    if (Math.abs(current - targetVolume) < 0.05) {
                        audio.volume = targetVolume;
                        if (targetVolume === 0) {
                            if (isMuted) audio.pause();
                        } else if (audio.paused) {
                            audio.play().catch(() => {});
                        }
                        clearInterval(fade);
                    } else {
                        if (current < targetVolume) {
                            if (audio.paused) audio.play().catch(() => {});
                            audio.volume = Math.min(1, current + 0.05);
                        } else {
                            audio.volume = Math.max(0, current - 0.05);
                        }
                    }
                }, 100);

                return () => clearInterval(fade);
            }, [volume, isMuted, shouldDuck]);

            return (
                <audio 
                    ref={audioRef} 
                    src={tracks[currentTrackIndex]} 
                    onEnded={() => setCurrentTrackIndex(prev => (prev + 1) % tracks.length)}
                />
            );
        };

        function App() {
            const [isAdult, setIsAdult] = useState(() => safeStorage.get('oracle_adult') === 'true');
            const [chaosUnlocked, setChaosUnlocked] = useState(() => safeStorage.get('oracle_chaos_unlocked') === 'true');
            const [layer, setLayer] = useState(() => {
                const adult = safeStorage.get('oracle_adult');
                const user = safeStorage.get('oracle_user');
                if (adult === null) return 'AGE';
                if (user === null) return 'NAME';
                return safeStorage.get('oracle_unlocked') === 'true' ? 'MAIN' : 'SECURITY';
            });

            const [username, setUsername] = useState(() => safeStorage.get('oracle_user') || '');
            const [avatar, setAvatar] = useState(() => safeStorage.get('oracle_avatar') || 'üîÆ');
            const [userColor, setUserColor] = useState(() => safeStorage.get('oracle_color') || '#D4AF37');
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isViewOnce, setIsViewOnce] = useState(false);
            const [uploadPreview, setUploadPreview] = useState(null);
            const [selectedFile, setSelectedFile] = useState(null);
            const [fateMode, setFateMode] = useState(false);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [currentAudioId, setCurrentAudioId] = useState(null);
            const [typingUsers, setTypingUsers] = useState({});
            const [replyingTo, setReplyingTo] = useState(null);
            const [editingMsg, setEditingMsg] = useState(null);
            const [showMenu, setShowMenu] = useState(false);
            const [showAttachmentMenu, setShowAttachmentMenu] = useState(false);
            const [showClearConfirm, setShowClearConfirm] = useState(false);
            const [isInputFocused, setIsInputFocused] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [viewingSecret, setViewingSecret] = useState(null);
            const [bgMusicVolume, setBgMusicVolume] = useState(0.3);
            const [bgMusicMuted, setBgMusicMuted] = useState(false);
            const [pinInput, setPinInput] = useState('');
            const [chaosPinInput, setChaosPinInput] = useState('');
            const [showChaosUnlock, setShowChaosUnlock] = useState(false);
            const [isUploading, setIsUploading] = useState(false);
            const [gameLevel, setGameLevel] = useState(null);
            const [gameCard, setGameCard] = useState(null);
            const [gameType, setGameType] = useState(null);

            const [filterSender, setFilterSender] = useState('');
            const [filterCategory, setFilterCategory] = useState('');
            const [filterStartDate, setFilterStartDate] = useState('');
            const [filterEndDate, setFilterEndDate] = useState('');
            const [showFilterMenu, setShowFilterMenu] = useState(false);

            const [activeCard, setActiveCard] = useState(null);
            const [readReceipts, setReadReceipts] = useState({});
            const feedRef = useRef(null);
            const lastTypingRef = useRef(0);
            const fileInputRef = useRef(null);
            const appRef = useRef(null);

            useEffect(() => {
                const loader = document.getElementById('loader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
                
                // Register Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js').catch(e => console.error(e));
                }
            }, []);

            useEffect(() => {
                if (layer !== 'MAIN') return;

                const initialize = async () => {
                    const { data: messagesData } = await supabaseClient.from('Pesan').select('*').order('id', { ascending: true });
                    if (messagesData) setMessages(messagesData);

                    const { data: cardData } = await supabaseClient.from('Tantangan').select('*').eq('is_active', true).single();
                    if (cardData) setActiveCard(cardData);
                };

                initialize();
                
                const channel = supabaseClient.channel('msgs');
                
                channel
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'Pesan' }, (p) => {
                        setMessages(prev => [...prev, p.new]);
                    })
                    .on('broadcast', { event: 'typing' }, ({ payload }) => {
                        if (payload.user !== username) {
                            setTypingUsers(prev => ({ ...prev, [payload.user]: payload.isTyping ? Date.now() : 0 }));
                        }
                    })
                    .on('broadcast', { event: 'read' }, ({ payload }) => {
                        setMessages(prev => prev.map(m => 
                            m.id === payload.messageId ? { ...m, is_read: true } : m
                        ));
                    })
                    .subscribe();
                
                const typingCleanup = setInterval(() => {
                    const now = Date.now();
                    setTypingUsers(prev => {
                        const next = { ...prev };
                        let changed = false;
                        for (const user in next) {
                            if (next[user] > 0 && now - next[user] > 3000) {
                                next[user] = 0;
                                changed = true;
                            }
                        }
                        return changed ? next : prev;
                    });
                }, 1000);

                return () => {
                    supabaseClient.removeChannel(channel);
                    clearInterval(typingCleanup);
                };
            }, [layer]);

            useEffect(() => {
                if (feedRef.current) feedRef.current.scrollTop = feedRef.current.scrollHeight;
            }, [messages]);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const setAppHeight = () => {
                    if (appRef.current) {
                        appRef.current.style.height = `${window.innerHeight}px`;
                    }
                };

                setAppHeight();
                window.addEventListener('resize', setAppHeight);

                return () => {
                    window.removeEventListener('resize', setAppHeight);
                };
            }, []);

            const handleSend = async () => {
                if (!inputText.trim() && !selectedFile) return;
                
                setIsUploading(true);
                try {
                    const nama = `${username}|${avatar}|${userColor}`;
                    let teks = inputText;

                    if (selectedFile) {
                        const url = await uploadImage(selectedFile);
                        teks = teks.trim() ? `[IMG]${url}\n${teks}` : `[IMG]${url}`;
                        setSelectedFile(null);
                        setUploadPreview(null);
                    }

                    if (editingMsg) {
                        await supabaseClient.from('Pesan').update({ teks }).eq('id', editingMsg.id);
                        setMessages(prev => prev.map(m => m.id === editingMsg.id ? { ...m, teks } : m));
                        setEditingMsg(null);
                        setInputText('');
                        return;
                    }

                    if (replyingTo) {
                        const replyContext = {
                            name: replyingTo.nama.split('|')[0],
                            text: replyingTo.teks
                        };
                        teks = `[REPLY:${JSON.stringify(replyContext)}]${teks}`;
                    }

                    if (isViewOnce) teks = `[VO]${teks}`;
                    
                    await supabaseClient.from('Pesan').insert([{ nama, teks }]);
                    setInputText('');
                    setIsViewOnce(false);
                    setReplyingTo(null);
                    
                    // Stop typing
                    supabaseClient.channel('msgs').send({
                        type: 'broadcast',
                        event: 'typing',
                        payload: { user: username, isTyping: false }
                    });
                } catch (err) {
                    console.error("Send error:", err);
                    const msg = err.message || "Terjadi kesalahan yang tidak diketahui";
                    alert(`Gagal mengirim pesan: ${msg}`);
                } finally {
                    setIsUploading(false);
                }
            };

            const handleMessageVisible = async (messageId) => {
                // Only mark as read if it's not our own message
                const msg = messages.find(m => m.id === messageId);
                if (msg && !msg.nama.startsWith(username) && !msg.is_read) {
                    // Update locally
                    setMessages(prev => prev.map(m => m.id === messageId ? { ...m, is_read: true } : m));
                    
                    // Update DB
                    await supabaseClient.from('Pesan').update({ is_read: true }).eq('id', messageId);

                    // Broadcast to others
                    supabaseClient.channel('msgs').send({
                        type: 'broadcast',
                        event: 'read',
                        payload: { messageId, reader: username }
                    });
                }
            };

            const handleVoiceNote = async (blob, durationSec) => {
                setIsUploading(true);
                try {
                    if (blob.size < 100) {
                        throw new Error("Rekaman terlalu pendek atau kosong.");
                    }

                    // 1. Determine MIME type and Extension
                    let mimeType = blob.type;
                    // Fallback if blob.type is empty
                    if (!mimeType) {
                        mimeType = 'audio/webm'; // Default for Chrome/Firefox
                    }
                    
                    let ext = 'webm';
                    if (mimeType.includes('mp4')) {
                        ext = 'mp4';
                    } else if (mimeType.includes('aac')) {
                        ext = 'aac';
                    } else if (mimeType.includes('ogg')) {
                        ext = 'ogg';
                    } else if (mimeType.includes('wav')) {
                        ext = 'wav';
                    }

                    console.log(`Uploading VN: ${mimeType} -> .${ext}`);

                    const fileName = `${Date.now()}.${ext}`;
                    const filePath = `voice/${fileName}`;
                    
                    // 2. Upload with correct Content-Type
                    // Strip parameters like "codecs=opus"
                    const cleanContentType = mimeType.split(';')[0];

                    const { error } = await supabaseClient.storage.from('voice note').upload(filePath, blob, {
                        contentType: cleanContentType,
                        upsert: false
                    });
                    
                    if (error) throw new Error(error.message);
                    
                    const { data } = supabaseClient.storage.from('voice note').getPublicUrl(filePath);
                    const publicUrl = data.publicUrl;
                    
                    // Verify if the URL is accessible (Public Bucket Check)
                    try {
                        const check = await fetch(publicUrl); // Use GET to be more thorough
                        if (!check.ok) {
                            console.error("Public URL check failed:", check.status, check.statusText);
                            let warningMessage = `PERINGATAN: Audio mungkin tidak bisa diputar (Error: ${check.status}).\n\n`;
                            if (check.status === 403 || check.status === 401) {
                                warningMessage += "Bucket 'voice note' sepertinya PRIVATE atau memerlukan otorisasi.\nMohon ubah menjadi PUBLIC di dashboard Supabase:\nStorage > Policies > dan pastikan ada policy untuk SELECT publik.";
                            } else if (check.status === 404) {
                                warningMessage += "File tidak ditemukan setelah di-upload. Cek path upload dan aturan bucket.";
                            } else {
                                warningMessage += "Masalah koneksi atau konfigurasi server. Cek status Supabase.";
                            }
                            alert(warningMessage);
                        } else {
                            const returnedContentType = check.headers.get('content-type');
                            console.log('Verified URL. Server Content-Type:', returnedContentType);
                            if (returnedContentType && !returnedContentType.startsWith('audio/')) {
                                alert(`PERINGATAN: Server mengirim tipe file yang salah! (${returnedContentType}). Audio mungkin tidak akan diputar.`);
                            }
                        }
                    } catch (e) {
                        console.error("Could not verify URL due to network error (CORS?):", e);
                        alert("Gagal memverifikasi URL audio setelah upload. Kemungkinan ada masalah CORS pada bucket Supabase Anda. Periksa pengaturan CORS di dashboard.");
                    }

                    const nama = `${username}|${avatar}|${userColor}`;
                    // Append duration to the URL with a pipe separator
                    let teks = `[VN]${publicUrl}|${durationSec}`;
                    await supabaseClient.from('Pesan').insert([{ nama, teks }]);
                } catch (err) {
                    console.error("VN Upload Error:", err);
                    alert("Gagal mengirim pesan suara: " + err.message);
                } finally {
                    setIsUploading(false);
                }
            };

            const audioManagerRef = useRef(new AudioManager());
            const recordingStartTimeRef = useRef(0);
            const isPressingRef = useRef(false);

            const startRecording = async (e) => {
                if (e && e.cancelable && e.type.startsWith('touch')) e.preventDefault();
                if (isPressingRef.current) return; // Prevent double trigger
                
                isPressingRef.current = true;
                try {
                    await audioManagerRef.current.startRecording();
                    
                    // If user released button while we were initializing
                    if (!isPressingRef.current) {
                        await audioManagerRef.current.stopRecording();
                        return;
                    }

                    recordingStartTimeRef.current = Date.now();
                    setIsRecording(true);
                    if (navigator.vibrate) navigator.vibrate(50);
                } catch (e) {
                    console.error("Mic error:", e);
                    if (isPressingRef.current) {
                        alert("Gagal mengakses mikrofon: " + e.message);
                    }
                    isPressingRef.current = false;
                    setIsRecording(false);
                }
            };

            const stopRecording = async (e) => {
                if (e && e.cancelable) e.preventDefault();
                
                isPressingRef.current = false;
                
                if (isRecording) {
                    setIsRecording(false);
                    const blob = await audioManagerRef.current.stopRecording();
                    const durationMs = Date.now() - recordingStartTimeRef.current;
                    const durationSec = durationMs / 1000;
                    
                    // Only send if duration is reasonable (> 0.5s) to avoid accidental taps
                    if (blob && blob.size > 1000 && durationSec > 0.5) {
                        handleVoiceNote(blob, durationSec);
                    }
                } else {
                    // Ensure cleanup even if not officially "recording" yet (e.g. during startup)
                    await audioManagerRef.current.stopRecording();
                }
            };

            const handleViewOnce = async (msg) => {
                try {
                    let teks = msg.teks || "";
                    if (teks.startsWith("[VO]")) teks = teks.substring(4);

                    let replyData = null;
                    const replyRegex = /^\[REPLY:(.+?)\](.*)$/s;
                    const match = teks.match(replyRegex);
                    if (match) {
                        try {
                            replyData = JSON.parse(match[1]);
                            teks = match[2].trim();
                        } catch (e) {}
                    }

                    let type = "text";
                    let content = teks;
                    if (teks.startsWith("[VN]")) {
                        type = "vn";
                        content = teks.substring(4);
                    } else if (teks.startsWith("[IMG]")) {
                        type = "img";
                        content = teks.substring(5);
                    }

                    setViewingSecret({ type, content, replyData });
                    
                    // Burn the message immediately from database
                    await supabaseClient.from('Pesan').delete().eq('id', msg.id);
                    // Also remove locally to prevent re-clicks before sync
                    setMessages(prev => prev.filter(m => m.id !== msg.id));
                } catch (e) {
                    console.error("Burn error:", e);
                    alert("‚ö†Ô∏è Pesan Tidak Terbaca atau Sudah Terbakar");
                }
            };

            const handleInputChange = (e) => {
                setInputText(e.target.value);
                const now = Date.now();
                if (now - lastTypingRef.current > 2000) {
                    lastTypingRef.current = now;
                    supabaseClient.channel('msgs').send({
                        type: 'broadcast',
                        event: 'typing',
                        payload: { user: username, isTyping: true }
                    });
                }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    alert("Ukuran gambar terlalu besar (Maksimal 5MB)");
                    return;
                }

                setSelectedFile(file);
                const reader = new FileReader();
                reader.onload = (e) => setUploadPreview(e.target.result);
                reader.readAsDataURL(file);
            };

            const handleFate = async (category) => {
                setFateMode(false);
                drawGameCard(category);
            };

            const drawGameCard = (level) => {
                if (level === 'chaos' && !chaosUnlocked) {
                    setShowChaosUnlock(true);
                    return;
                }
                const deck = window.GAME_DECK[level];
                const rand = Math.random();
                let type;
                let card;

                if (rand < deck.wildcardChance) {
                    type = 'WILDCARD';
                    card = deck.wildcard[Math.floor(Math.random() * deck.wildcard.length)];
                } else {
                    const subRand = Math.random();
                    if (subRand < 0.5) {
                        type = 'TRUTH';
                        card = deck.truth[Math.floor(Math.random() * deck.truth.length)];
                    } else {
                        type = 'DARE';
                        card = deck.dare[Math.floor(Math.random() * deck.dare.length)];
                    }
                }

                setGameLevel(level);
                setGameType(type);
                setGameCard(card);
                setLayer('GAME');
                setShowMenu(false);
            };

            const handlePinSubmit = () => {
                const cleanPin = pinInput.trim();
                if (!cleanPin) {
                    alert("PIN tidak boleh kosong.");
                    return;
                }
                if (!/^\d+$/.test(cleanPin)) {
                    alert("PIN hanya boleh berisi angka.");
                    return;
                }

                if (cleanPin === '010304') {
                    safeStorage.set('oracle_unlocked', 'true');
                    setLayer('MAIN');
                } else {
                    alert("Kode Salah. Silakan coba lagi.");
                }
            };

            const handleChaosUnlock = () => {
                if (chaosPinInput === '181225') {
                    safeStorage.set('oracle_chaos_unlocked', 'true');
                    setChaosUnlocked(true);
                    setShowChaosUnlock(false);
                    alert("Mode Chaos Terbuka. Gunakan dengan bijak.");
                } else {
                    alert("Kode Salah.");
                }
            };

            const getFilteredMessages = useMemo(() => {
                let filtered = messages;

                if (filterSender) {
                    filtered = filtered.filter(msg => msg.nama.split('|')[0].toLowerCase().includes(filterSender.toLowerCase()));
                }

                if (filterCategory) {
                    filtered = filtered.filter(msg => {
                        if (msg.nama === "ORACLE") {
                            try {
                                const d = JSON.parse(msg.teks);
                                const parts = d.content.split(":");
                                const type = parts[0].toLowerCase();
                                return type.includes(filterCategory.toLowerCase());
                            } catch { return false; }
                        }
                        return false;
                    });
                }

                if (filterStartDate) {
                    const start = new Date(filterStartDate);
                    filtered = filtered.filter(msg => new Date(msg.created_at) >= start);
                }

                if (filterEndDate) {
                    const end = new Date(filterEndDate);
                    end.setHours(23, 59, 59, 999); // End of the day
                    filtered = filtered.filter(msg => new Date(msg.created_at) <= end);
                }

                return filtered;
            }, [messages, filterSender, filterCategory, filterStartDate, filterEndDate]);

            const handleClearAll = async () => {
                await supabaseClient.from('Pesan').delete().neq('id', 0);
                setMessages([]);
                setShowClearConfirm(false);
                setShowMenu(false);
            };

            if (layer === 'AGE') return (
                <div className="h-screen bg-black flex flex-col items-center justify-center p-6 text-center space-y-12">
                    <div className="space-y-4">
                        <h1 className="font-header text-gold text-4xl tracking-[15px] drop-shadow-[0_0_15px_rgba(212,175,55,0.3)]">ORACLE</h1>
                        <p className="text-white/30 text-[10px] uppercase tracking-[5px]">Sanctum of Truth & Chaos</p>
                    </div>
                    <div className="space-y-6">
                        <p className="text-white/60 text-xs italic font-mystic">"Apakah kamu cukup dewasa untuk menghadapi takdirmu?"</p>
                        <div className="flex flex-col gap-4">
                            <button onClick={() => { safeStorage.set('oracle_adult', 'true'); setIsAdult(true); setLayer('NAME'); }} className="px-12 py-4 border border-gold/40 text-gold text-[10px] uppercase tracking-[8px] hover:bg-gold/10 transition-all rounded-full">SAYA 18+ (DEWASA)</button>
                            <button onClick={() => { safeStorage.set('oracle_adult', 'false'); setIsAdult(false); setLayer('NAME'); }} className="px-12 py-4 border border-white/10 text-white/40 text-[10px] uppercase tracking-[8px] hover:bg-white/5 transition-all rounded-full">DI BAWAH 18 TAHUN</button>
                        </div>
                    </div>
                </div>
            );

            if (layer === 'NAME') return (
                <div className="h-screen bg-black flex flex-col items-center justify-center p-8 space-y-10">
                    <div className="text-center space-y-2">
                        <h2 className="font-header text-gold text-xl tracking-[8px]">IDENTITAS</h2>
                        <p className="text-[8px] text-white/20 uppercase tracking-[3px]">Bagaimana dunia harus memanggilmu?</p>
                    </div>
                    <div className="w-full max-w-xs space-y-8">
                        <input value={username} onChange={e => setUsername(e.target.value)} placeholder="NAMA SAMARAN..." className="w-full bg-transparent border-b border-white/10 py-3 text-center text-gold font-header tracking-widest focus:border-gold outline-none transition-all" />
                        <div className="grid grid-cols-4 gap-3">
                            {['üîÆ', 'üßø', 'üïØÔ∏è', 'üåô', '‚òÄÔ∏è', 'üåë', 'ü™ê', 'üíÄ'].map(a => (
                                <button key={a} onClick={() => setAvatar(a)} className={`text-2xl p-2 rounded-xl border ${avatar === a ? 'bg-gold/20 border-gold' : 'border-white/5'}`}>{a}</button>
                            ))}
                        </div>
                        <button 
                            onClick={() => { 
                                const cleanName = username.trim();
                                if (!cleanName) {
                                    alert("Nama tidak boleh kosong.");
                                    return;
                                }
                                if (cleanName.length < 2) {
                                    alert("Nama terlalu pendek (min. 2 karakter).");
                                    return;
                                }
                                if (!/^[a-zA-Z0-9\s]+$/.test(cleanName)) {
                                    alert("Nama hanya boleh berisi huruf dan angka.");
                                    return;
                                }
                                safeStorage.set('oracle_user', cleanName); 
                                safeStorage.set('oracle_avatar', avatar); 
                                safeStorage.set('oracle_color', userColor); 
                                setLayer('SECURITY'); 
                            }} 
                            className="w-full py-4 bg-gold text-black text-[10px] font-bold uppercase tracking-[5px] rounded-xl"
                        >
                            MASUK SANCTUM
                        </button>
                    </div>
                </div>
            );

            if (layer === 'SECURITY') return (
                <div className="h-screen bg-black flex flex-col items-center justify-center p-8 space-y-12">
                    <div className="text-center space-y-4">
                        <div className="text-4xl animate-pulse">üé≠</div>
                        <h2 className="font-header text-gold text-xl tracking-[10px]">BUAT KARAKTER</h2>
                        <p className="text-[8px] text-white/20 uppercase tracking-[4px]">Masukkan Kode: 010304</p>
                    </div>
                    <div className="w-full max-w-xs space-y-6">
                        <input 
                            type="text" 
                            value={pinInput} 
                            onChange={e => setPinInput(e.target.value)} 
                            placeholder="KODE..." 
                            className="w-full bg-transparent border-b border-white/10 py-3 text-center text-gold font-header tracking-widest focus:border-gold outline-none transition-all"
                        />
                        <button onClick={handlePinSubmit} className="w-full py-4 bg-gold text-black text-[10px] font-bold uppercase tracking-[5px] rounded-xl">BANGKITKAN KARAKTER</button>
                    </div>
                </div>
            );

            if (layer === 'GAME') return (
                <div className="h-screen bg-black flex flex-col items-center justify-center p-8 space-y-12 relative overflow-hidden">
                    <div className={`absolute inset-0 opacity-20 blur-[100px] transition-all duration-1000 ${
                        gameType === 'TRUTH' ? 'bg-blue-500' : gameType === 'DARE' ? 'bg-red-500' : 'bg-gold'
                    }`}></div>

                    <div className="text-center space-y-4 z-10">
                        <div className="text-[10px] font-header text-gold/60 tracking-[5px] uppercase">{gameLevel} MODE</div>
                        <h2 className={`font-header text-4xl tracking-[10px] ${
                            gameType === 'TRUTH' ? 'text-blue-400' : gameType === 'DARE' ? 'text-red-400' : 'text-gold'
                        }`}>{gameType}</h2>
                    </div>

                    <div className="w-full max-w-xs glass p-8 rounded-3xl border border-white/10 text-center space-y-8 z-10 animate-fade-in">
                        <p className="text-white/80 font-mystic text-xl leading-relaxed italic">
                            "{gameCard}"
                        </p>
                        
                        <div className="pt-4 space-y-3">
                            <button 
                                onClick={async () => {
                                    const nama = "ORACLE";
                                    const teks = JSON.stringify({ 
                                        content: `GAME ${gameLevel.toUpperCase()} ${gameType}:${gameCard}`, 
                                        invoker: username 
                                    });
                                    await supabaseClient.from('Pesan').insert([{ nama, teks }]);
                                    setLayer('MAIN');
                                }} 
                                className="w-full py-4 bg-white/10 text-white text-[10px] font-bold uppercase tracking-[5px] rounded-xl hover:bg-white/20 transition-all"
                            >
                                SELESAI & KIRIM
                            </button>
                            <button 
                                onClick={() => setLayer('MAIN')} 
                                className="w-full py-4 text-white/40 text-[8px] font-bold uppercase tracking-[3px] hover:text-white transition-all"
                            >
                                KEMBALI
                            </button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div ref={appRef} className="flex flex-col bg-void overflow-hidden">
                    <BackgroundMusic 
                        tracks={[
                            "https://rruxlxoeelxjjjmhafkc.supabase.co/storage/v1/object/public/suara/gemini_generated_media_49b9b318.mp3",
                            "https://rruxlxoeelxjjjmhafkc.supabase.co/storage/v1/object/public/suara/gemini_generated_media_a10e9509.mp3",
                            "https://rruxlxoeelxjjjmhafkc.supabase.co/storage/v1/object/public/suara/gemini_generated_media_6d98b4f4.mp3"
                        ]}
                        volume={bgMusicVolume}
                        isMuted={bgMusicMuted}
                        shouldDuck={isRecording || currentAudioId !== null}
                    />
                    <header className="p-4 border-b border-white/5 bg-black/80 backdrop-blur-md z-10 flex justify-between items-center relative">
                        <div className="font-header text-gold text-[10px] tracking-widest">ORACLE v17.9</div>
                        <div className="text-[10px] font-mono text-white/60 tracking-[2px] uppercase">{currentTime.toLocaleTimeString()}</div>
                        <button onClick={() => setShowFilterMenu(true)} className="text-white/40 text-xl mr-2">‚åï</button>
                        <button onClick={() => setShowMenu(!showMenu)} className="text-white/40 text-xl">‚ãÆ</button>
                        
                        {showMenu && (
                            <div className="absolute right-4 top-14 w-64 glass rounded-2xl shadow-2xl z-50 overflow-hidden animate-fade-in border border-white/10">
                                <div className="p-4 border-b border-white/5 space-y-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-[10px] uppercase tracking-widest text-gold">Musik Latar</span>
                                        <button onClick={() => setBgMusicMuted(!bgMusicMuted)} className="text-xs text-white/60 hover:text-white">
                                            {bgMusicMuted ? 'üîá Muted' : 'üîä On'}
                                        </button>
                                    </div>
                                    <input 
                                        type="range" 
                                        min="0" 
                                        max="1" 
                                        step="0.1" 
                                        value={bgMusicVolume} 
                                        onChange={(e) => setBgMusicVolume(parseFloat(e.target.value))}
                                        className="w-full accent-gold h-1 bg-white/10 rounded-lg appearance-none cursor-pointer"
                                    />
                                </div>
                                <button onClick={() => { setLayer('NAME'); setShowMenu(false); }} className="w-full p-4 text-left text-[10px] uppercase tracking-widest border-b border-white/5 hover:bg-white/5">Ubah Identitas</button>
                                <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="w-full p-4 text-left text-[10px] uppercase tracking-widest border-b border-white/5 hover:bg-white/5">Reset Profil & Usia</button>
                                <button onClick={() => { setShowClearConfirm(true); setShowMenu(false); }} className="w-full p-4 text-left text-[10px] uppercase tracking-widest text-red-400 hover:bg-red-500/10">Hapus Semua Pesan</button>
                            </div>
                        )}
                    </header>

                    <div ref={feedRef} className="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar feed-container">
                        {getFilteredMessages.map(m => (
                            <Bubble 
                                key={m.id} 
                                msg={m} 
                                isMe={m.nama.startsWith(username)} 
                                onReply={setReplyingTo}
                                onEdit={msg => { setEditingMsg(msg); setInputText(msg.teks); }}
                                onViewOnce={handleViewOnce}
                                onPlayAudio={setCurrentAudioId}
                                currentAudioId={currentAudioId}
                                onVisible={handleMessageVisible}
                            />
                        ))}
                        
                        {Object.values(typingUsers).some(t => t > 0) && (
                            <div className="text-[8px] text-gold/40 font-header tracking-widest animate-pulse px-4 py-2 italic">
                                Seseorang sedang membisikkan takdir...
                            </div>
                        )}
                    </div>

                    <div className="p-2 bg-[#121b22] border-t border-white/5 relative">
                        {isViewOnce && (
                            <div className="absolute top-[-30px] right-4 bg-red-600/90 text-white text-[8px] px-3 py-1 rounded-full uppercase tracking-[2px] font-bold animate-pulse shadow-lg z-[120] border border-white/20">
                                üëÅÔ∏è Mode Rahasia Aktif
                            </div>
                        )}
                        {uploadPreview && (
                            <div className="absolute top-[-160px] left-4 right-4 bg-[#1e2a30] p-3 rounded-2xl border border-gold/30 shadow-2xl animate-fade-in flex flex-col gap-2 z-[110]">
                                <div className="flex justify-between items-center">
                                    <span className="text-[10px] text-gold font-header tracking-widest uppercase">Pratinjau Gambar</span>
                                    <button onClick={() => { setUploadPreview(null); setSelectedFile(null); }} className="text-white/40 text-xs p-1">‚úï</button>
                                </div>
                                <div className="relative h-24 w-full bg-black/20 rounded-lg overflow-hidden flex items-center justify-center">
                                    <img src={uploadPreview} className="h-full object-contain" />
                                    {isUploading && (
                                        <div className="absolute inset-0 bg-black/60 flex flex-col items-center justify-center gap-2">
                                            <div className="w-6 h-6 border-2 border-gold border-t-transparent rounded-full animate-spin"></div>
                                            <span className="text-[8px] text-gold font-header tracking-widest uppercase">Mengirim...</span>
                                        </div>
                                    )}
                                </div>
                                {isViewOnce && (
                                    <div className="flex items-center gap-2 text-[8px] text-red-400 uppercase tracking-widest font-bold">
                                        <span>üëÅÔ∏è Mode Rahasia Aktif</span>
                                    </div>
                                )}
                            </div>
                        )}
                        {isUploading && !uploadPreview && (
                            <div className="absolute top-[-60px] left-4 right-4 bg-black/60 backdrop-blur-md p-2 rounded-xl flex items-center gap-3 animate-pulse border border-gold/20">
                                <div className="w-10 h-10 bg-zinc-800 rounded-lg flex items-center justify-center text-xl">‚è≥</div>
                                <div className="flex flex-col">
                                    <span className="text-[10px] text-gold font-header tracking-widest uppercase">Uploading...</span>
                                    <span className="text-[8px] text-white/40 uppercase">Takdir sedang diproses</span>
                                </div>
                            </div>
                        )}
                        {replyingTo && (
                            <div className="absolute top-[-50px] left-0 right-0 bg-[#1e2a30] border-t border-gold/20 p-2 flex items-center justify-between animate-fade-in">
                                <div className="text-[10px] text-white/60 truncate italic px-2">
                                    <span className="text-gold font-bold not-italic">Membalas {replyingTo.nama.split('|')[0]}:</span> {parsePreviewText(replyingTo.teks)}
                                </div>
                                <button onClick={() => setReplyingTo(null)} className="text-gold text-xs px-2">‚úï</button>
                            </div>
                        )}
                        {editingMsg && (
                            <div className="absolute top-[-50px] left-0 right-0 bg-[#1e2a30] border-t border-blue-500/20 p-2 flex items-center justify-between animate-fade-in">
                                <div className="text-[10px] text-blue-400 truncate italic px-2">
                                    <span className="font-bold not-italic">Mengedit pesan...</span>
                                </div>
                                <button onClick={() => { setEditingMsg(null); setInputText(''); }} className="text-blue-400 text-xs px-2">‚úï</button>
                            </div>
                        )}

                        <div className="flex items-center gap-1.5">
                            <button 
                                onClick={() => setShowAttachmentMenu(!showAttachmentMenu)} 
                                className={`w-10 h-10 flex items-center justify-center text-white/60 transition-transform flex-shrink-0 ${showAttachmentMenu ? 'rotate-45' : ''}`}
                            >
                                <span className="text-3xl">+</span>
                            </button>
                            
                            <div className="flex-1 bg-[#2a3942] rounded-full flex items-center px-4 py-1 shadow-inner min-w-0">
                                <input 
                                    value={inputText} 
                                    onChange={handleInputChange} 
                                    onFocus={() => setIsInputFocused(true)}
                                    onBlur={() => setIsInputFocused(false)}
                                    onKeyPress={e => e.key === 'Enter' && handleSend()} 
                                    placeholder="Ketik pesan..." 
                                    className="flex-1 bg-transparent py-2.5 text-[16px] text-white outline-none min-w-0" 
                                />
                            </div>

                            <div className="flex items-center gap-1.5 flex-shrink-0">
                                {(!inputText.trim() && !editingMsg) && (
                                    <button 
                                        onMouseDown={startRecording} 
                                        onMouseUp={stopRecording}
                                        onMouseLeave={stopRecording}
                                        onTouchStart={startRecording} 
                                        onTouchEnd={stopRecording}
                                        onTouchCancel={stopRecording}
                                        className={`w-12 h-12 rounded-full flex items-center justify-center shadow-xl active:scale-125 transition-all flex-shrink-0 ${isRecording ? 'bg-red-500 animate-pulse' : 'bg-[#00a884] text-white'}`}
                                    >
                                        <span className="text-xl">üé§</span>
                                    </button>
                                )}
                                <button 
                                    onClick={handleSend} 
                                    disabled={(!inputText.trim() && !selectedFile) && !editingMsg}
                                    className={`w-12 h-12 rounded-full text-white flex items-center justify-center shadow-xl active:scale-90 transition-transform flex-shrink-0 ${((!inputText.trim() && !selectedFile) && !editingMsg) ? 'bg-gray-600 opacity-50' : 'bg-[#00a884]'}`}
                                >
                                    <span className="text-xl">{isUploading ? '...' : (editingMsg ? '‚úì' : '‚û§')}</span>
                                </button>
                            </div>
                        </div>
                        <input type="file" ref={fileInputRef} onChange={handleImageUpload} className="hidden" accept="image/*" />
                        
                        {showAttachmentMenu && (
                            <div className="absolute bottom-20 left-4 right-4 bg-[#232d36] rounded-3xl p-6 shadow-2xl border border-white/5 grid grid-cols-3 gap-6 animate-fade-in z-[100]">
                                <button onClick={() => { fileInputRef.current.click(); setShowAttachmentMenu(false); }} className="flex flex-col items-center gap-2">
                                    <div className="w-14 h-14 rounded-full bg-purple-600 flex items-center justify-center text-2xl shadow-lg">üñºÔ∏è</div>
                                    <span className="text-[11px] text-white/80 font-medium">Galeri</span>
                                </button>
                                <button onClick={() => { setFateMode(true); setShowAttachmentMenu(false); }} className="flex flex-col items-center gap-2">
                                    <div className="w-14 h-14 rounded-full bg-orange-600 flex items-center justify-center text-2xl shadow-lg">üîÆ</div>
                                    <span className="text-[11px] text-white/80 font-medium">Takdir</span>
                                </button>
                                <button 
                                    onClick={() => { 
                                        setIsViewOnce(!isViewOnce); 
                                        setShowAttachmentMenu(false); 
                                    }} 
                                    className="flex flex-col items-center gap-2"
                                >
                                    <div className={`w-14 h-14 rounded-full flex items-center justify-center text-2xl shadow-lg transition-colors ${isViewOnce ? 'bg-red-600' : 'bg-zinc-600'}`}>üëÅÔ∏è</div>
                                    <span className="text-[11px] text-white/80 font-medium">Rahasia</span>
                                </button>
                            </div>
                        )}
                    </div>

                    {fateMode && (
                        <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-[150] flex items-center justify-center p-6">
                            <div className="w-full max-w-sm space-y-8 animate-fade-in relative">
                                <button onClick={() => setFateMode(false)} className="absolute -top-4 -right-4 w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-white/40 text-xl">‚úï</button>
                                
                                <div className="text-center space-y-2">
                                    <h3 className="font-header text-gold text-xl tracking-[10px]">PILIH TAKDIR</h3>
                                    <p className="text-[8px] text-white/30 uppercase tracking-[4px]">Tentukan intensitas permainan</p>
                                </div>
                                <div className="grid grid-cols-1 gap-4">
                                    <button onClick={() => handleFate('light')} className="p-6 glass rounded-2xl border border-gold/20 text-left group active:scale-95 transition-transform">
                                        <div className="text-gold font-header text-sm tracking-widest mb-1">LIGHT</div>
                                        <div className="text-[9px] text-white/40 uppercase tracking-widest">Truth & Dare Ringan</div>
                                    </button>
                                    <button onClick={() => handleFate('deep')} className="p-6 glass rounded-2xl border border-gold/20 text-left group active:scale-95 transition-transform">
                                        <div className="text-gold font-header text-sm tracking-widest mb-1">DEEP</div>
                                        <div className="text-[9px] text-white/40 uppercase tracking-widest">Pertanyaan Mendalam</div>
                                    </button>
                                    <button 
                                        onClick={() => {
                                            if (!isAdult) {
                                                alert("Mode Chaos hanya untuk Dewasa (18+). Silakan reset profil jika Anda salah memilih usia.");
                                                return;
                                            }
                                            chaosUnlocked ? handleFate('chaos') : setShowChaosUnlock(true);
                                        }} 
                                        className={`p-6 glass rounded-2xl border transition-all active:scale-95 ${chaosUnlocked ? 'border-red-500/30' : 'border-white/5'} text-left group`}
                                    >
                                        <div className={`${chaosUnlocked ? 'text-red-400' : 'text-white/40'} font-header text-sm tracking-widest mb-1`}>CHAOS {chaosUnlocked ? '' : 'üîí'}</div>
                                        <div className="text-[9px] text-white/40 uppercase tracking-widest">
                                            {!isAdult ? 'Hanya untuk 18+' : chaosUnlocked ? 'Seksual & Sensual (18+)' : 'Tekan untuk memasukkan PIN'}
                                        </div>
                                    </button>
                                </div>
                                <button onClick={() => setFateMode(false)} className="w-full py-4 text-white/20 text-[10px] uppercase tracking-widest">Batal</button>
                            </div>
                        </div>
                    )}

                    {showChaosUnlock && (
                        <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-[200] flex items-center justify-center p-8">
                            <div className="w-full max-w-xs space-y-8 animate-fade-in text-center">
                                <div className="space-y-2">
                                    <h3 className="font-header text-red-500 text-lg tracking-[8px]">VERIFIKASI CHAOS</h3>
                                    <p className="text-[8px] text-white/20 uppercase tracking-[3px]">Masukkan PIN 18+ untuk Membuka</p>
                                </div>
                                <input 
                                    type="password" 
                                    value={chaosPinInput} 
                                    onChange={e => setChaosPinInput(e.target.value)} 
                                    placeholder="PIN..." 
                                    className="w-full bg-transparent border-b border-white/10 py-3 text-center text-red-400 font-header tracking-widest focus:border-red-500 outline-none transition-all"
                                />
                                <div className="flex gap-4">
                                    <button onClick={() => setShowChaosUnlock(false)} className="flex-1 py-3 border border-white/10 rounded-xl text-[10px] uppercase tracking-widest">Batal</button>
                                    <button onClick={handleChaosUnlock} className="flex-1 py-3 bg-red-500 text-white rounded-xl text-[10px] font-bold uppercase tracking-widest">Buka</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showClearConfirm && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
                            <div className="glass p-8 rounded-3xl border border-red-500/30 max-w-xs w-full text-center space-y-6 animate-fade-in">
                                <div className="text-4xl">‚ö†Ô∏è</div>
                                <h3 className="font-header text-red-400 text-lg tracking-widest">HAPUS SEMUA?</h3>
                                <p className="text-[10px] text-white/40 leading-relaxed">Tindakan ini akan menghapus seluruh jejak takdir di sanctum ini selamanya.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowClearConfirm(false)} className="flex-1 py-3 border border-white/10 rounded-xl text-[10px] uppercase tracking-widest">Batal</button>
                                    <button onClick={handleClearAll} className="flex-1 py-3 bg-red-500 text-white rounded-xl text-[10px] font-bold uppercase tracking-widest">Hapus</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showFilterMenu && (
                        <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-[250] flex items-center justify-center p-6">
                            <div className="w-full max-w-sm space-y-8 animate-fade-in relative">
                                <button onClick={() => setShowFilterMenu(false)} className="absolute -top-4 -right-4 w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-white/40 text-xl">‚úï</button>
                                
                                <div className="text-center space-y-2">
                                    <h3 className="font-header text-gold text-xl tracking-[10px]">FILTER PESAN</h3>
                                    <p className="text-[8px] text-white/30 uppercase tracking-[4px]">Saring berdasarkan kriteria</p>
                                </div>
                                <div className="grid grid-cols-1 gap-4">
                                    <input 
                                        type="text" 
                                        placeholder="Filter Pengirim..." 
                                        value={filterSender}
                                        onChange={e => setFilterSender(e.target.value)}
                                        className="w-full bg-transparent border-b border-white/10 py-3 text-center text-gold font-header tracking-widest focus:border-gold outline-none transition-all"
                                    />
                                    <select 
                                        value={filterCategory}
                                        onChange={e => setFilterCategory(e.target.value)}
                                        className="w-full bg-transparent border-b border-white/10 py-3 text-center text-gold font-header tracking-widest focus:border-gold outline-none transition-all"
                                    >
                                        <option value="">Semua Kategori</option>
                                        <option value="truth">Truth</option>
                                        <option value="dare">Dare</option>
                                        <option value="wildcard">Wildcard</option>
                                    </select>
                                    <input 
                                        type="date" 
                                        value={filterStartDate}
                                        onChange={e => setFilterStartDate(e.target.value)}
                                        className="w-full bg-transparent border-b border-white/10 py-3 text-center text-gold font-header tracking-widest focus:border-gold outline-none transition-all"
                                    />
                                    <input 
                                        type="date" 
                                        value={filterEndDate}
                                        onChange={e => setFilterEndDate(e.target.value)}
                                        className="w-full bg-transparent border-b border-white/10 py-3 text-center text-gold font-header tracking-widest focus:border-gold outline-none transition-all"
                                    />
                                </div>
                                <button onClick={() => { setFilterSender(''); setFilterCategory(''); setFilterStartDate(''); setFilterEndDate(''); setShowFilterMenu(false); }} className="w-full py-4 text-white/20 text-[10px] uppercase tracking-widest">Reset Filter</button>
                            </div>
                        </div>
                    )}

                    {viewingSecret && (
                        <div className="fixed inset-0 bg-black/95 backdrop-blur-xl z-[200] flex items-center justify-center p-8" onClick={() => setViewingSecret(null)}>
                            <div className="text-center space-y-8 animate-fade-in max-w-sm w-full" onClick={e => e.stopPropagation()}>
                                <div className="text-gold text-[10px] font-header tracking-[10px] uppercase opacity-50">Secret Revealed</div>
                                <div className="bg-white/5 p-6 rounded-3xl border border-white/10 shadow-2xl relative overflow-hidden">
                                    <div className="absolute inset-0 bg-gradient-to-br from-red-500/5 to-transparent pointer-events-none"></div>
                                    {viewingSecret.replyData && (
                                        <div className="mb-4 p-2 rounded bg-black/20 border-l-4 border-gold/50 text-[10px] opacity-60 italic text-left">
                                            <span className="font-bold text-gold not-italic">{viewingSecret.replyData.name}:</span> {parsePreviewText(viewingSecret.replyData.text)}
                                        </div>
                                    )}
                                    <MessageContent 
                                        type={viewingSecret.type} 
                                        content={viewingSecret.content} 
                                        msgId="secret" 
                                        currentAudioId={currentAudioId} 
                                        onPlayAudio={setCurrentAudioId} 
                                        isSecret={true}
                                    />
                                </div>
                                <button onClick={() => setViewingSecret(null)} className="text-white/20 text-[8px] uppercase tracking-widest border border-white/10 px-6 py-2 rounded-full hover:bg-white/5 transition-colors">Tap anywhere to burn this memory</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = window.ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
