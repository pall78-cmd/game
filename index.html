<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Oracle v17.9 - Harmony Enhanced</title>
    <meta name="theme-color" content="#050508" />
    
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Cormorant+Garamond:ital,wght@0,500;1,500&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #D4AF37; --void: #050508; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--void);
            color: #f0f0f0;
            font-family: 'Montserrat', sans-serif;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
            position: fixed;
        }
        .font-header { font-family: 'Cinzel', serif; }
        .font-mystic { font-family: 'Cormorant Garamond', serif; }
        #universe {
            position: fixed; inset:0; z-index:0;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000 100%);
        }
        #universe::before {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px);
            background-size: 550px 550px, 350px 350px;
            animation: cosmicDrift 120s linear infinite;
            opacity: 0.4;
        }
        @keyframes cosmicDrift { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        #loader {
            position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #000; z-index: 9999; transition: opacity 0.8s; gap: 20px;
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom": "https://esm.sh/react-dom@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.48.1",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
    <div id="loader">
        <div class="font-header text-gold text-xs tracking-[5px] animate-pulse">INITIATING ORACLE...</div>
        <div id="error-display" class="hidden text-red-500 text-[10px] font-mono mt-4 text-center px-4"></div>
    </div>
    <div id="root"></div>

    <!-- SEMUA LOGIKA DIPINDAHKAN KE SINI -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { createClient } from '@supabase/supabase-js';

        // --- CONFIG ---
        const SUPA_URL = 'https://rruxlxoeelxjjjmhafkc.supabase.co';
        const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJydXhseG9lZWx4ampqbWhhZmtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDU5OTMsImV4cCI6MjA4NTMyMTk5M30.oR2hl_BDD1P6Dmtos2So-aJ_eoFl1-Kwybt6mQnvq0Q';
        const supabase = createClient(SUPA_URL, SUPA_KEY);

        const safeStorage = {
            get: (key) => { try { return localStorage.getItem(key); } catch { return null; } },
            set: (key, value) => { try { localStorage.setItem(key, value); } catch { } }
        };

        const LIGHT_TRUTHS = ["Siapa selebriti crush pertamamu?", "Makanan aneh yang kamu suka?", "Kapan terakhir ngompol?", "Guru paling dibenci?", "Kebohongan terakhir?"];
        const LIGHT_DARES = ["Kirim stiker teraneh.", "VN lagu nasional pakai 'O'.", "Foto lantai sekarang.", "Selfie ekspresi jelek."];
        const LIGHT_WILDCARDS = ["Tunjuk siapa saja buat jawab Truth.", "Pilih member buat VN nyanyi.", "Semua kirim emoji buat kamu."];

        const DEEP_TRUTHS = ["Kapan terakhir menangis?", "Penyesalan terbesar tahun ini?", "Siapa yang paling dirindukan?", "Ketakutan masa depan?"];
        const DEEP_DARES = ["Chat mantan 'Aku kangen'.", "Ceritakan rahasia terdalam.", "VN terima kasih ke ortu.", "Foto masa kecil memalukan."];
        const DEEP_WILDCARDS = ["Semua jawab: Apa arti bahagia?", "Ungkap rahasia atau jujur rasa.", "Puji 1 orang di grup."];

        const CHAOS_TRUTHS = ["Fantasi terliar?", "Kapan terakhir turn on?", "Posisi favorit?", "Warna pakaian dalam?"];
        const CHAOS_DARES = ["Foto leher View Once.", "VN kata-kata nakal.", "VN suara ciuman.", "VN panggil Daddy/Mommy."];
        const CHAOS_WILDCARDS = ["VN desah atau foto bibir.", "Cerita mimpi basah atau pap paha.", "Turn on terbesar?"];

        const createFreshDeck = () => ({
            light: { truths: [...LIGHT_TRUTHS], dares: [...LIGHT_DARES], wildcards: [...LIGHT_WILDCARDS] },
            deep: { truths: [...DEEP_TRUTHS], dares: [...DEEP_DARES], wildcards: [...DEEP_WILDCARDS] },
            chaos: { truths: [...CHAOS_TRUTHS], dares: [...CHAOS_DARES], wildcards: [...CHAOS_WILDCARDS] }
        });

        const initDeck = () => {
            const saved = localStorage.getItem('oracle_deck_v17_9');
            return saved ? JSON.parse(saved) : createFreshDeck();
        };

        const drawCard = (currentDeck, intensity) => {
            const key = intensity.toLowerCase();
            const roll = Math.random();
            let type;
            let prefix = "";

            if (roll < 0.15) { type = 'wildcards'; prefix = "WILD: "; }
            else if (roll < 0.57) { type = 'truths'; prefix = "TRUTH: "; }
            else { type = 'dares'; prefix = "DARE: "; }

            let pool = currentDeck[key][type];
            if (!pool || pool.length === 0) pool = createFreshDeck()[key][type];

            const idx = Math.floor(Math.random() * pool.length);
            let card = pool[idx];
            const newPool = [...pool]; newPool.splice(idx, 1);
            const newDeck = { ...currentDeck, [key]: { ...currentDeck[key], [type]: newPool } };
            localStorage.setItem('oracle_deck_v17_9', JSON.stringify(newDeck));
            return { content: prefix + card, newDeck };
        };

        // --- COMPONENTS ---
        const Bubble = ({ msg, isMe, username }) => {
            const isOracle = msg.nama === "ORACLE";
            let content = msg.teks;
            let invoker = "";
            let type = "FATE";

            if (isOracle) {
                try {
                    const d = JSON.parse(msg.teks);
                    const parts = d.content.split(":");
                    type = parts[0] || "FATE";
                    content = parts.slice(1).join(":").trim() || d.content;
                    invoker = d.invoker;
                } catch { content = "Pesan Takdir Rusak"; }
            }

            return (
                <div className={`flex flex-col mb-4 animate-fade-in ${isMe ? 'items-end' : 'items-start'}`}>
                    {!isOracle && <span className={`text-[7px] font-header uppercase tracking-[2px] mb-1 px-3 ${isMe ? 'text-gold/50' : 'text-white/30'}`}>{msg.nama}</span>}
                    <div className={`p-3 max-w-[85%] rounded-2xl border transition-all ${
                        isOracle ? 'w-full max-w-full bg-transparent border-none' : 
                        isMe ? 'bg-zinc-900/60 border-gold/20 text-gold/90 rounded-br-none shadow-xl' : 
                        'bg-zinc-800/40 border-white/5 text-white/80 rounded-bl-none shadow-md'
                    }`}>
                        {isOracle ? (
                            <div className="p-5 rounded-2xl border border-gold/40 bg-gradient-to-br from-black to-zinc-900 text-center space-y-4 shadow-2xl relative overflow-hidden">
                                <div className="text-[9px] font-header text-gold tracking-[5px] uppercase opacity-60">{type}</div>
                                <div className="font-mystic text-lg italic text-white/90 leading-relaxed px-2">"{content}"</div>
                                <div className="pt-2 border-t border-white/5 text-[7px] opacity-40 uppercase tracking-widest font-header text-center w-full">Invoked by {invoker}</div>
                            </div>
                        ) : (
                            <p className="font-mystic text-[16px] leading-relaxed break-words whitespace-pre-wrap">{content}</p>
                        )}
                    </div>
                </div>
            );
        };

        function App() {
            const [isAdult, setIsAdult] = useState(() => safeStorage.get('oracle_adult') === 'true');
            const [layer, setLayer] = useState(() => safeStorage.get('oracle_adult') !== null ? 'SECURITY' : 'AGE');
            const [username, setUsername] = useState(() => safeStorage.get('oracle_user') || '');
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [fateMode, setFateMode] = useState(false);
            const feedRef = useRef(null);
            const deckRef = useRef(initDeck());

            // Hilangkan loader saat aplikasi siap
            useEffect(() => {
                if (layer === 'MAIN' || layer === 'AGE') {
                    const loader = document.getElementById('loader');
                    if (loader) {
                        setTimeout(() => {
                            loader.style.opacity = '0';
                            setTimeout(() => loader.remove(), 800);
                        }, 500);
                    }
                }
            }, [layer]);

            useEffect(() => {
                if (layer !== 'MAIN') return;
                const fetchMessages = async () => {
                    const { data } = await supabase.from('Pesan').select('*').order('id', { ascending: true });
                    if (data) setMessages(data);
                    setTimeout(() => feedRef.current?.scrollTo(0, feedRef.current.scrollHeight), 500);
                };
                fetchMessages();

                const sub = supabase.channel('msgs').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'Pesan' }, (p) => {
                    setMessages(prev => [...prev, p.new]);
                    setTimeout(() => feedRef.current?.scrollTo(0, feedRef.current.scrollHeight), 100);
                }).subscribe();
                return () => { supabase.removeChannel(sub); };
            }, [layer]);

            const handleFate = async (int) => {
                setFateMode(false);
                const { content, newDeck } = drawCard(deckRef.current, int);
                deckRef.current = newDeck;
                await supabase.from('Pesan').insert([{ nama: "ORACLE", teks: JSON.stringify({ content, invoker: username }) }]);
            };

            const handleSendText = async () => {
                if (!inputText.trim()) return;
                const t = inputText; setInputText('');
                await supabase.from('Pesan').insert([{ nama: username, teks: t }]);
            };

            if (layer === 'AGE') return (
                <div className="h-screen bg-black flex flex-col items-center justify-center p-6 text-center space-y-8 relative z-20">
                    <h1 className="font-header text-gold text-2xl tracking-widest">VERIFIKASI USIA</h1>
                    <div className="grid grid-cols-2 gap-4 w-full max-w-[300px]">
                        <button onClick={() => { setIsAdult(false); safeStorage.set('oracle_adult', 'false'); setLayer('SECURITY'); }} className="p-4 border border-white/20 rounded-xl text-xs active:scale-95 transition-transform">DI BAWAH 18</button>
                        <button onClick={() => { setIsAdult(true); safeStorage.set('oracle_adult', 'true'); setLayer('SECURITY'); }} className="p-4 border border-gold/40 rounded-xl text-gold text-xs active:scale-95 transition-transform">18+ TAHUN</button>
                    </div>
                </div>
            );

            if (layer === 'SECURITY') return (
                <div className="h-screen bg-black flex flex-col items-center justify-center p-6 space-y-6 relative z-20">
                    <h1 className="font-header text-gold tracking-[10px]">GATEWAY</h1>
                    <input type="password" placeholder="ACCESS CODE" autoFocus onChange={(e) => { if (e.target.value === '010304') setLayer(username ? 'MAIN' : 'NAME'); }} className="bg-transparent border-b border-gold text-center py-4 outline-none text-gold tracking-[10px] w-full max-w-[200px]" />
                    <p className="text-[8px] opacity-20 uppercase tracking-widest">Identity Protected by Void</p>
                </div>
            );

            if (layer === 'NAME') return (
                <div className="h-screen bg-black flex flex-col items-center justify-center p-6 space-y-10 relative z-20">
                    <h1 className="font-header text-gold tracking-[5px]">SIAPA NAMAMU?</h1>
                    <input type="text" maxLength={12} placeholder="NAMA..." onChange={(e) => setUsername(e.target.value)} className="bg-transparent border-b border-white text-center py-2 outline-none w-full max-w-[250px] font-mystic text-xl text-white" />
                    <button onClick={() => { if (username.trim()) { safeStorage.set('oracle_user', username); setLayer('MAIN'); } }} className="px-12 py-3 border border-gold text-gold font-header tracking-widest text-xs active:bg-gold active:text-black transition-all">MANIFEST</button>
                </div>
            );

            return (
                <div className="h-screen bg-void flex flex-col relative overflow-hidden">
                    <div id="universe"></div>
                    <header className="p-4 border-b border-white/5 bg-black/80 backdrop-blur-md z-10 flex justify-between items-center">
                        <div className="font-header text-gold text-[10px] tracking-widest">ORACLE v17.9</div>
                        <button onClick={async () => { if(confirm("Clear room?")) await supabase.from('Pesan').delete().neq('id', 0); }} className="text-[9px] text-red-500/40 uppercase">Clear</button>
                    </header>

                    <div ref={feedRef} className="flex-1 overflow-y-auto p-4 z-10 space-y-1 scroll-smooth">
                        {messages.map(m => <Bubble key={m.id} msg={m} isMe={m.nama === username} username={username} />)}
                    </div>

                    {fateMode && (
                        <div className="absolute inset-x-0 bottom-24 z-50 p-6 bg-black/95 border-t border-gold/20 flex flex-col gap-4 rounded-t-3xl backdrop-blur-xl animate-fade-in">
                            <div className="grid grid-cols-3 gap-2">
                                <button onClick={()=>handleFate('LIGHT')} className="py-4 border border-blue-500/30 text-blue-400 text-[10px] font-header rounded-lg active:bg-blue-500/10">LIGHT</button>
                                <button onClick={()=>handleFate('DEEP')} className="py-4 border border-purple-500/30 text-purple-400 text-[10px] font-header rounded-lg active:bg-purple-500/10">DEEP</button>
                                <button disabled={!isAdult} onClick={()=>handleFate('CHAOS')} className={`py-4 border border-red-500/30 text-red-500 text-[10px] font-header rounded-lg ${!isAdult ? 'opacity-10' : 'active:bg-red-500/10'}`}>CHAOS</button>
                            </div>
                            <button onClick={()=>setFateMode(false)} className="text-white/20 text-[9px] uppercase tracking-widest">Close</button>
                        </div>
                    )}

                    <div className="p-4 pb-8 bg-black/90 border-t border-white/5 z-20 space-y-4">
                        <button onClick={()=>setFateMode(true)} className="w-full py-3 bg-gold/5 border border-gold/40 text-gold font-header text-[9px] tracking-[5px] uppercase rounded-lg active:scale-[0.98] transition-transform">Panggil Takdir</button>
                        <div className="flex gap-3 items-center px-1">
                            <input type="text" value={inputText} onChange={(e)=>setInputText(e.target.value)} onKeyDown={(e)=>e.key==='Enter' && handleSendText()} placeholder="Type something..." className="flex-1 bg-transparent border-b border-white/10 py-1 outline-none text-white text-sm font-mystic" />
                            <button onClick={handleSendText} className="text-gold text-lg px-2 active:scale-125 transition-transform">âž¤</button>
                        </div>
                    </div>
                </div>
            );
        }

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (e) {
            const errDisp = document.getElementById('error-display');
            if(errDisp) {
                errDisp.innerText = "Fatal: " + e.message;
                errDisp.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>